{% extends "base.html" %}

{% block title %}계약서 서명 - {{ contract.title }}{% endblock %}

{% block head_extra %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
{% endblock %}

{% block page_css_block %}
<style>
:root {
    --primary: #e85d26;
    --primary-hover: #d14e1a;
    --bg: #f5f5f5;
    --card-bg: #fff;
    --border: #e0e0e0;
    --text: #1a1a1a;
    --text2: #888;
    --text3: #aaa;
    --success: #16a34a;
    --success-bg: #dcfce7;
    --danger: #dc2626;
    --danger-bg: #fef2f2;
    --warning-bg: #fffbeb;
    --radius: 12px;
    --shadow: 0 2px 8px rgba(0,0,0,.08);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: 'Noto Sans KR', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
}

/* ============================================
   헤더
   ============================================ */
.sign-header {
    background: #1a1f2e;
    color: #fff;
    padding: 14px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    position: sticky;
    top: 0;
    z-index: 100;
}
.sign-header .brand { font-size: 18px; font-weight: 700; flex-shrink: 0; }
.sign-header .brand span { color: var(--primary); }
.sign-header .contract-title {
    font-size: 14px;
    color: #9ca3b4;
    margin-left: auto;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* ============================================
   메인 레이아웃 (단일 컬럼, 중앙 정렬)
   ============================================ */
.sign-main {
    max-width: 720px;
    margin: 0 auto;
    padding: 20px 16px 120px;
}

/* ============================================
   카드 공통
   ============================================ */
.card {
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    margin-bottom: 20px;
}
.card-header {
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 14px;
    font-weight: 600;
}

/* ============================================
   PDF 뷰어 (PDF.js 캔버스)
   ============================================ */
.pdf-viewer-body {
    background: #e8e8e8;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    position: relative;
}
.pdf-scroll-container {
    transform-origin: top center;
    transition: transform 0.15s ease;
    padding: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
}
.pdf-page-canvas {
    display: block;
    box-shadow: 0 2px 8px rgba(0,0,0,.12);
    background: #fff;
    max-width: 100%;
    height: auto;
}
.pdf-loading {
    padding: 60px 20px;
    text-align: center;
    color: var(--text2);
    font-size: 14px;
}
.zoom-controls {
    display: flex;
    align-items: center;
    gap: 6px;
}
.zoom-btn {
    width: 32px; height: 32px;
    border: 1px solid var(--border); background: var(--card-bg);
    border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    color: var(--text); transition: background .15s; font-family: inherit;
}
.zoom-btn:hover { background: #f0f0f0; }
.zoom-level {
    font-size: 12px; color: var(--text2);
    min-width: 40px; text-align: center; font-weight: 500;
}
.page-info {
    font-size: 12px; color: var(--text2); font-weight: 500;
}

/* ============================================
   진행률 바
   ============================================ */
.progress-section {
    padding: 16px 18px;
}
.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-size: 13px;
    font-weight: 600;
}
.progress-count { color: var(--primary); }
.progress-bar-track {
    width: 100%;
    height: 6px;
    background: #e8e8e8;
    border-radius: 3px;
    overflow: hidden;
}
.progress-bar-fill {
    height: 100%;
    background: var(--primary);
    border-radius: 3px;
    transition: width 0.3s ease;
    width: 0%;
}
.progress-bar-fill.complete { background: var(--success); }

/* ============================================
   입력 폼 필드
   ============================================ */
.fields-header {
    padding: 16px 18px 12px;
    font-size: 15px;
    font-weight: 700;
    color: var(--text);
    border-bottom: 1px solid var(--border);
}
.field-group {
    padding: 14px 18px;
    border-bottom: 1px solid #f0f0f0;
}
.field-group:last-child { border-bottom: none; }

.field-label {
    font-size: 13px;
    font-weight: 600;
    color: #444;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
}
.field-label .req { color: var(--danger); font-weight: 700; }
.field-label .badge-readonly {
    font-size: 10px;
    background: #f0f0f0;
    color: #888;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
}
.field-label .badge-type {
    font-size: 10px;
    background: #eef2ff;
    color: #4f46e5;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
}

.field-input {
    width: 100%;
    padding: 11px 14px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-size: 15px;
    font-family: inherit;
    color: var(--text);
    background: #fff;
    transition: border-color .15s, box-shadow .15s;
    -webkit-appearance: none;
}
.field-input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(232,93,38,.12);
}
.field-input:disabled,
.field-input.readonly {
    background: #f8f8f8;
    color: #666;
    cursor: default;
    border-color: #eee;
}

/* 서명/도장 영역 */
.sig-area {
    border: 2px dashed #d0d0d0;
    border-radius: 10px;
    padding: 16px;
    text-align: center;
    cursor: pointer;
    transition: border-color .2s, background .2s;
    min-height: 90px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 4px;
    background: #fafafa;
}
.sig-area:hover {
    border-color: var(--primary);
    background: #fff5f0;
}
.sig-area.filled {
    border-style: solid;
    border-color: var(--success);
    background: #f0fdf4;
}
.sig-area img {
    max-width: 100%;
    max-height: 80px;
    object-fit: contain;
}
.sig-area .placeholder-icon { font-size: 24px; color: var(--text3); }
.sig-area .placeholder-text { font-size: 13px; color: var(--text2); }

/* 체크박스 */
.check-field {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    cursor: pointer;
    padding: 4px 0;
}
.check-field input[type="checkbox"] {
    width: 22px;
    height: 22px;
    accent-color: var(--primary);
    cursor: pointer;
    flex-shrink: 0;
}

/* 이미지 필드 */
.image-field-display {
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 8px;
    background: #fafafa;
    text-align: center;
}
.image-field-display img {
    max-width: 100%;
    max-height: 160px;
    object-fit: contain;
    border-radius: 4px;
}
.image-field-display .no-image {
    color: var(--text3);
    font-size: 13px;
    padding: 16px;
}

/* ============================================
   하단 고정 바
   ============================================ */
.bottom-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    border-top: 1px solid var(--border);
    padding: 12px 16px;
    z-index: 200;
    display: flex;
    justify-content: center;
}
.bottom-bar-inner {
    max-width: 720px;
    width: 100%;
}
.submit-btn {
    width: 100%;
    padding: 15px;
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    font-family: inherit;
    min-height: 52px;
    transition: background .15s, opacity .15s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.submit-btn:hover { background: var(--primary-hover); }
.submit-btn:disabled { opacity: .5; cursor: not-allowed; }

/* ============================================
   상태 배너 (서명 완료 / 만료 / 취소)
   ============================================ */
.status-banner {
    border-radius: var(--radius);
    padding: 32px 24px;
    text-align: center;
    font-size: 15px;
    font-weight: 500;
    line-height: 1.6;
}
.status-banner .banner-icon { font-size: 48px; margin-bottom: 12px; display: block; }
.status-banner .banner-title { font-size: 17px; font-weight: 700; margin-bottom: 6px; }
.status-banner .banner-sub { font-size: 13px; margin-top: 6px; opacity: 0.8; }

.status-banner.success {
    background: var(--success-bg);
    border: 1px solid #86efac;
    color: #166534;
}
.status-banner.danger {
    background: var(--danger-bg);
    border: 1px solid #fca5a5;
    color: #991b1b;
}

/* ============================================
   서명 확인 모달
   ============================================ */
.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.5);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    padding: 16px;
}
.modal-overlay.show { display: flex; }

.modal-card {
    background: #fff;
    border-radius: var(--radius);
    padding: 28px 24px;
    width: 100%;
    max-width: 400px;
    text-align: center;
}
.modal-card .modal-icon { font-size: 40px; margin-bottom: 12px; display: block; }
.modal-card .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 8px; }
.modal-card .modal-desc {
    font-size: 13px;
    color: var(--text2);
    margin-bottom: 24px;
    line-height: 1.6;
}
.modal-actions {
    display: flex;
    gap: 10px;
}
.modal-actions button {
    flex: 1;
    padding: 13px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    border: none;
    min-height: 46px;
    transition: background .15s;
}
.modal-btn-cancel { background: #f0f0f0; color: var(--text); }
.modal-btn-cancel:hover { background: #e4e4e4; }
.modal-btn-confirm { background: var(--primary); color: #fff; }
.modal-btn-confirm:hover { background: var(--primary-hover); }

/* ============================================
   서명 패드 모달
   ============================================ */
.sig-modal-card {
    max-width: 500px;
    text-align: left;
}
.sig-modal-card h3 {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 14px;
}
.sig-canvas-wrap {
    border: 2px solid #ddd;
    border-radius: 8px;
    background: #fff;
    margin-bottom: 14px;
    overflow: hidden;
}
.sig-canvas-wrap canvas { width: 100%; height: 200px; display: block; }
.sig-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}
.sig-actions button {
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    border: none;
    min-height: 42px;
    transition: background .15s;
}
.sig-act-clear { background: #f0f0f0; color: var(--text); }
.sig-act-clear:hover { background: #e4e4e4; }
.sig-act-cancel { background: #f0f0f0; color: var(--text); }
.sig-act-cancel:hover { background: #e4e4e4; }
.sig-act-confirm { background: var(--primary); color: #fff; }
.sig-act-confirm:hover { background: var(--primary-hover); }

/* ============================================
   토스트
   ============================================ */
.toast {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    background: #1a1a1a;
    color: #fff;
    padding: 14px 24px;
    border-radius: 10px;
    font-size: 14px;
    z-index: 3000;
    display: none;
    box-shadow: 0 4px 16px rgba(0,0,0,.25);
    max-width: 90%;
    text-align: center;
}

/* ============================================
   모바일 최적화
   ============================================ */
@media (max-width: 768px) {
    .sign-main { padding: 12px 8px 120px; }
    .sign-header .contract-title { font-size: 12px; max-width: 50%; }
    .field-input {
        font-size: 16px; /* iOS 줌 방지 */
        padding: 13px 14px;
    }
    .sig-canvas-wrap canvas { height: 160px; }
    .sig-modal-card { max-width: none; }
    .sig-area { min-height: 100px; }
    .check-field input[type="checkbox"] { width: 26px; height: 26px; }
}
</style>
{% endblock %}

{% block body_content %}
<!-- 헤더 -->
<div class="sign-header">
    <div class="brand">Hume<span>tix</span></div>
    <div class="contract-title">{{ contract.title }}</div>
</div>

<div class="sign-main">

{% if contract.is_expired %}
    <!-- 만료된 계약 -->
    <div class="card">
        <div class="card-header">계약 상태</div>
        <div style="padding:24px;">
            <div class="status-banner danger">
                <span class="banner-icon">&#9200;</span>
                <div class="banner-title">서명 기한이 만료되었습니다</div>
                <div class="banner-sub">관리자에게 문의해 주세요.</div>
            </div>
        </div>
    </div>

{% elif contract.status == 'cancelled' %}
    <!-- 취소된 계약 -->
    <div class="card">
        <div class="card-header">계약 상태</div>
        <div style="padding:24px;">
            <div class="status-banner danger">
                <span class="banner-icon">&#10060;</span>
                <div class="banner-title">이 계약은 취소되었습니다</div>
                <div class="banner-sub">관리자에게 문의해 주세요.</div>
            </div>
        </div>
    </div>

{% elif already_signed %}
    <!-- PDF 뷰어 (서명 완료 — 완성된 계약서) -->
    <div class="card">
        <div class="card-header">
            <span>완성된 계약서</span>
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomOut()">−</button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="zoom-btn" onclick="zoomReset()" style="font-size:12px;">↺</button>
            </div>
        </div>
        <div class="pdf-viewer-body" id="pdfViewerBody">
            <div class="pdf-scroll-container" id="pdfScrollContainer">
                <div class="pdf-loading" id="pdfLoading">PDF 문서를 불러오는 중...</div>
            </div>
        </div>
        <div style="padding:8px 16px;text-align:center;border-top:1px solid var(--border);">
            <span class="page-info" id="pageInfo"></span>
        </div>
    </div>

    <!-- 서명 완료 배너 -->
    <div class="card">
        <div style="padding:24px;">
            <div class="status-banner success">
                <span class="banner-icon">&#10004;</span>
                <div class="banner-title">서명이 완료되었습니다</div>
                {% if participant.signed_at %}
                <div class="banner-sub">서명일시: {{ participant.signed_at.strftime('%Y-%m-%d %H:%M') }}</div>
                {% endif %}
            </div>
            {% if contract.final_pdf_path %}
            <a href="/sign/{{ participant.sign_token }}/download"
               style="display:block;margin-top:16px;padding:14px;background:var(--primary);color:#fff;
                      border-radius:10px;text-align:center;text-decoration:none;font-size:15px;font-weight:600;">
                &#128196; 완성된 계약서 다운로드
            </a>
            {% endif %}
        </div>
    </div>

{% else %}
    <!-- PDF 뷰어 (서명 전 — 서식 템플릿) -->
    <div class="card">
        <div class="card-header">
            <span>계약서 문서</span>
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomOut()">−</button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="zoom-btn" onclick="zoomReset()" style="font-size:12px;">↺</button>
            </div>
        </div>
        <div class="pdf-viewer-body" id="pdfViewerBody">
            <div class="pdf-scroll-container" id="pdfScrollContainer">
                <div class="pdf-loading" id="pdfLoading">PDF 문서를 불러오는 중...</div>
            </div>
        </div>
        <div style="padding:8px 16px;text-align:center;border-top:1px solid var(--border);">
            <span class="page-info" id="pageInfo"></span>
        </div>
    </div>

    <!-- 진행률 + 입력 폼 -->
    <div class="card" id="formCard">
        <div class="progress-section" id="progressSection">
            <div class="progress-header">
                <span>입력 진행률</span>
                <span class="progress-count" id="progressCount">0 / 0</span>
            </div>
            <div class="progress-bar-track">
                <div class="progress-bar-fill" id="progressBarFill"></div>
            </div>
        </div>
        <div class="fields-header">{{ participant.name }}님 서명 항목</div>
        <div id="fieldsList"></div>
    </div>
{% endif %}

</div><!-- /.sign-main -->

{% if not already_signed and not contract.is_expired and contract.status != 'cancelled' %}
<!-- 하단 고정 서명 완료 버튼 -->
<div class="bottom-bar" id="bottomBar">
    <div class="bottom-bar-inner">
        <button class="submit-btn" id="submitBtn" onclick="onSubmitClick()">
            &#9997;&#65039; 서명 완료
        </button>
    </div>
</div>
{% endif %}

<!-- 서명 확인 모달 -->
<div class="modal-overlay" id="confirmModal">
    <div class="modal-card" style="max-width:440px;text-align:left;">
        <div style="text-align:center;">
            <span class="modal-icon" style="font-size:44px;">&#9888;&#65039;</span>
            <div class="modal-title" style="font-size:18px;">최종 확인</div>
            <div class="modal-desc" style="margin-bottom:20px;">
                모든 조건이 정확히 입력되었는지 확인해주세요.<br>
                서명 완료 후에는 내용을 수정할 수 없습니다.
            </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:24px;">
            <label class="check-field" style="align-items:flex-start;">
                <input type="checkbox" class="confirm-agree-cb" onchange="updateConfirmBtn()">
                <span style="font-size:14px;line-height:1.5;">전자계약 및 전자서명의 법적 효력에 대해 동의합니다.</span>
            </label>
            <label class="check-field" style="align-items:flex-start;">
                <input type="checkbox" class="confirm-agree-cb" onchange="updateConfirmBtn()">
                <span style="font-size:14px;line-height:1.5;">서명 완료 후 전자계약 문서를 원본으로 인정합니다.</span>
            </label>
            <label class="check-field" style="align-items:flex-start;">
                <input type="checkbox" class="confirm-agree-cb" onchange="updateConfirmBtn()">
                <span style="font-size:14px;line-height:1.5;">모든 서명자는 본 계약 내용을 확인하고 서명한 것에 동의합니다.</span>
            </label>
        </div>
        <div class="modal-actions" style="flex-direction:column;gap:8px;">
            <button class="modal-btn-confirm" id="confirmSignBtn" onclick="doSubmitSign()" style="width:100%;padding:15px;font-size:15px;" disabled>서명 완료 (전체 동의)</button>
            <button class="modal-btn-cancel" onclick="closeConfirmModal()" style="width:100%;padding:13px;">취소</button>
        </div>
    </div>
</div>

<!-- 서명 패드 모달 -->
<div class="modal-overlay" id="sigModal">
    <div class="modal-card sig-modal-card">
        <h3 id="sigModalTitle">서명</h3>
        <div class="sig-canvas-wrap">
            <canvas id="sigCanvas"></canvas>
        </div>
        <div class="sig-actions">
            <button class="sig-act-clear" onclick="clearSig()">지우기</button>
            <button class="sig-act-cancel" onclick="closeSigModal()">취소</button>
            <button class="sig-act-confirm" onclick="confirmSig()">확인</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>
{% endblock %}

{% block base_js %}
<script>
/* ============================================
   기본 데이터
   ============================================ */
const SIGN_TOKEN = '{{ participant.sign_token }}';
const CSRF_TOKEN = '{{ csrf_token() }}';
const TEMPLATE_ID = {{ template.id if template else 0 }};
const MY_ROLE = '{{ participant.role_key }}';
const ALREADY_SIGNED = {{ 'true' if already_signed else 'false' }};

const FIELDS = {{ template.fields|tojson if template else '[]' }};
const ALL_FIELDS = FIELDS.map((f, idx) => ({ ...f, _idx: idx }));
const MY_FIELDS = ALL_FIELDS.filter(f => f.role === MY_ROLE);

const OTHER_VALUES = {{ other_values|tojson if other_values is defined and other_values else '{}' }};
const PDF_URL = '{{ pdf_url }}';

let signaturePad = null;
let sigCallback = null;
let fieldValues = {};

/* ============================================
   유틸리티
   ============================================ */
function showToast(msg, duration) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.style.display = 'block';
    clearTimeout(el._timer);
    el._timer = setTimeout(() => el.style.display = 'none', duration || 3000);
}

function escHtml(str) {
    const d = document.createElement('div');
    d.textContent = str || '';
    return d.innerHTML;
}

const TYPE_LABELS = {
    text: '텍스트',
    date: '날짜',
    signature: '서명',
    stamp: '도장',
    checkbox: '동의',
    image: '이미지'
};

/* ============================================
   PDF.js 렌더링 (고해상도 캔버스)
   ============================================ */
pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let currentZoom = 1;
let pdfDoc = null;
let totalPages = 0;

async function loadPdf() {
    const container = document.getElementById('pdfScrollContainer');
    const loading = document.getElementById('pdfLoading');
    if (!container || !PDF_URL) return;

    try {
        pdfDoc = await pdfjsLib.getDocument({
            url: PDF_URL,
            cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
            cMapPacked: true,
        }).promise;
        totalPages = pdfDoc.numPages;

        if (loading) loading.remove();

        const dpr = Math.max(window.devicePixelRatio || 1, 3);

        for (let i = 1; i <= totalPages; i++) {
            const page = await pdfDoc.getPage(i);
            const vp = page.getViewport({ scale: 1 });
            const containerWidth = container.clientWidth - 24;
            const baseScale = containerWidth / vp.width;
            const renderScale = baseScale * dpr;
            const viewport = page.getViewport({ scale: renderScale });

            const canvas = document.createElement('canvas');
            canvas.className = 'pdf-page-canvas';
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            canvas.style.width = (viewport.width / dpr) + 'px';
            canvas.style.height = (viewport.height / dpr) + 'px';

            container.appendChild(canvas);

            await page.render({
                canvasContext: canvas.getContext('2d'),
                viewport: viewport,
            }).promise;
        }

        const pageInfo = document.getElementById('pageInfo');
        if (pageInfo) pageInfo.textContent = '전체 ' + totalPages + '페이지';

    } catch (err) {
        console.error('PDF 로드 실패:', err);
        if (loading) loading.textContent = 'PDF를 불러올 수 없습니다.';
    }
}

function zoomIn() {
    currentZoom = Math.min(currentZoom + 0.25, 3);
    applyZoom();
}

function zoomOut() {
    currentZoom = Math.max(currentZoom - 0.25, 0.5);
    applyZoom();
}

function zoomReset() {
    currentZoom = 1;
    applyZoom();
}

function applyZoom() {
    const sc = document.getElementById('pdfScrollContainer');
    if (sc) sc.style.transform = 'scale(' + currentZoom + ')';
    const zl = document.getElementById('zoomLevel');
    if (zl) zl.textContent = Math.round(currentZoom * 100) + '%';
}

function initPinchZoom() {
    const viewer = document.getElementById('pdfViewerBody');
    if (!viewer) return;
    let startDist = 0;
    let startZoom = 1;

    viewer.addEventListener('touchstart', function(e) {
        if (e.touches.length === 2) {
            e.preventDefault();
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            startDist = Math.sqrt(dx * dx + dy * dy);
            startZoom = currentZoom;
        }
    }, { passive: false });

    viewer.addEventListener('touchmove', function(e) {
        if (e.touches.length === 2) {
            e.preventDefault();
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const scale = dist / startDist;
            currentZoom = Math.max(0.5, Math.min(3, startZoom * scale));
            applyZoom();
        }
    }, { passive: false });
}

/* ============================================
   입력 폼 렌더링
   ============================================ */
function renderFields() {
    const container = document.getElementById('fieldsList');
    if (!container) return;
    container.innerHTML = '';

    if (MY_FIELDS.length === 0) {
        container.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text2);font-size:14px;">입력할 항목이 없습니다.</div>';
        /* 진행률 섹션 숨김 */
        const progressSection = document.getElementById('progressSection');
        if (progressSection) progressSection.style.display = 'none';
        return;
    }

    MY_FIELDS.forEach(f => {
        const div = document.createElement('div');
        div.className = 'field-group';
        div.dataset.fieldIdx = f._idx;

        const typeLabel = TYPE_LABELS[f.type] || f.type;
        const label = f.label || typeLabel;
        const reqMark = f.required ? '<span class="req">*</span>' : '';
        const isReadOnly = !!f.read_only;
        const defaultVal = f.default_value || '';

        let html = '<div class="field-label">';
        html += escHtml(label) + ' ' + reqMark;
        if (isReadOnly) {
            html += ' <span class="badge-readonly">자동입력</span>';
        }
        html += '</div>';

        if (f.type === 'text') {
            html += '<input type="text" class="field-input' + (isReadOnly ? ' readonly' : '') + '"' +
                    ' data-idx="' + f._idx + '"' +
                    ' oninput="onFieldInput(' + f._idx + ',this.value)"' +
                    ' placeholder="' + escHtml(label) + ' 입력"' +
                    ' value="' + escHtml(defaultVal) + '"' +
                    (isReadOnly ? ' disabled' : '') + '>';

        } else if (f.type === 'date') {
            html += '<input type="date" class="field-input' + (isReadOnly ? ' readonly' : '') + '"' +
                    ' data-idx="' + f._idx + '"' +
                    ' onchange="onFieldInput(' + f._idx + ',this.value)"' +
                    ' value="' + escHtml(defaultVal) + '"' +
                    (isReadOnly ? ' disabled' : '') + '>';

        } else if (f.type === 'signature' || f.type === 'stamp') {
            const sigLabel = f.type === 'signature' ? '서명' : '도장';
            if (isReadOnly && defaultVal) {
                /* 읽기전용 서명/도장: 이미지 표시만 */
                html += '<div class="image-field-display">';
                if (defaultVal.startsWith('data:') || defaultVal.startsWith('/uploads/') || defaultVal.startsWith('http')) {
                    html += '<img src="' + escHtml(defaultVal) + '" alt="' + escHtml(sigLabel) + '">';
                } else {
                    html += '<span class="no-image">' + escHtml(defaultVal) + '</span>';
                }
                html += '</div>';
            } else {
                html += '<div class="sig-area" data-idx="' + f._idx + '"' +
                        ' onclick="openSigModal(' + f._idx + ',\'' + f.type + '\')">';
                html += '<span class="placeholder-icon">&#9997;</span>';
                html += '<span class="placeholder-text">터치하여 ' + sigLabel + '하기</span>';
                html += '</div>';
            }

        } else if (f.type === 'checkbox') {
            const checked = (defaultVal === 'Y' && isReadOnly) ? ' checked' : '';
            html += '<label class="check-field">' +
                    '<input type="checkbox" data-idx="' + f._idx + '"' +
                    ' onchange="onFieldInput(' + f._idx + ',this.checked?\'Y\':\'\')"' +
                    checked +
                    (isReadOnly ? ' disabled' : '') + '>' +
                    ' 동의합니다</label>';

        } else if (f.type === 'image') {
            html += '<div class="image-field-display">';
            if (defaultVal) {
                if (defaultVal.startsWith('data:') || defaultVal.startsWith('/uploads/') || defaultVal.startsWith('http')) {
                    html += '<img src="' + escHtml(defaultVal) + '" alt="이미지">';
                } else {
                    /* 경로가 텍스트로만 저장된 경우에도 이미지로 시도 */
                    html += '<img src="' + escHtml(defaultVal) + '" alt="이미지"' +
                            ' onerror="this.parentElement.innerHTML=\'<span class=no-image>이미지를 불러올 수 없습니다</span>\'">';
                }
            } else {
                html += '<span class="no-image">이미지 없음</span>';
            }
            html += '</div>';
        }

        div.innerHTML = html;
        container.appendChild(div);
    });

    updateProgress();
}

/* ============================================
   진행률 업데이트
   ============================================ */
function updateProgress() {
    const requiredFields = MY_FIELDS.filter(f => f.required && !f.read_only && f.type !== 'image');
    const totalRequired = requiredFields.length;

    if (totalRequired === 0) {
        const progressSection = document.getElementById('progressSection');
        if (progressSection) progressSection.style.display = 'none';
        return;
    }

    let filledCount = 0;
    requiredFields.forEach(f => {
        let value = '';
        if (f.type === 'text') {
            const input = document.querySelector('input[type="text"][data-idx="' + f._idx + '"]');
            value = input ? input.value.trim() : '';
        } else if (f.type === 'date') {
            const input = document.querySelector('input[type="date"][data-idx="' + f._idx + '"]');
            value = input ? input.value : '';
        } else if (f.type === 'signature' || f.type === 'stamp') {
            value = fieldValues[f._idx] || '';
        } else if (f.type === 'checkbox') {
            const cb = document.querySelector('input[type="checkbox"][data-idx="' + f._idx + '"]');
            value = cb && cb.checked ? 'Y' : '';
        }
        if (value) filledCount++;
    });

    const pct = totalRequired > 0 ? Math.round((filledCount / totalRequired) * 100) : 0;
    const countEl = document.getElementById('progressCount');
    const barEl = document.getElementById('progressBarFill');

    if (countEl) countEl.textContent = filledCount + ' / ' + totalRequired;
    if (barEl) {
        barEl.style.width = pct + '%';
        if (pct >= 100) {
            barEl.classList.add('complete');
        } else {
            barEl.classList.remove('complete');
        }
    }
}

/* ============================================
   필드 입력 처리 + 같은 라벨 자동 기입
   ============================================ */
function onFieldInput(idx, value) {
    const hasValue = (value === 'Y') || (value && value.trim && value.trim() !== '');
    if (hasValue) {
        fieldValues[idx] = value;
    } else {
        delete fieldValues[idx];
    }

    /* 같은 라벨의 다른 필드에도 자동 기입 */
    const srcField = ALL_FIELDS.find(f => f._idx === idx);
    if (srcField && srcField.label && srcField.role === MY_ROLE && !srcField.read_only) {
        MY_FIELDS.forEach(f => {
            if (f._idx === idx) return;
            if (f.label !== srcField.label) return;
            if (f.type !== srcField.type) return;
            if (f.read_only) return;

            if (hasValue) {
                fieldValues[f._idx] = value;
            } else {
                delete fieldValues[f._idx];
            }

            /* UI 동기화 */
            if (f.type === 'text') {
                const input = document.querySelector('input[type="text"][data-idx="' + f._idx + '"]');
                if (input) input.value = value || '';
            } else if (f.type === 'date') {
                const input = document.querySelector('input[type="date"][data-idx="' + f._idx + '"]');
                if (input) input.value = value || '';
            } else if (f.type === 'checkbox') {
                const cb = document.querySelector('input[type="checkbox"][data-idx="' + f._idx + '"]');
                if (cb) cb.checked = (value === 'Y');
            }
        });
    }

    updateProgress();
}

/* ============================================
   서명 패드 모달
   ============================================ */
function openSigModal(fieldIdx, type) {
    const modal = document.getElementById('sigModal');
    document.getElementById('sigModalTitle').textContent =
        type === 'signature' ? '서명 입력' : '도장 날인';
    modal.classList.add('show');

    const canvas = document.getElementById('sigCanvas');
    canvas.width = canvas.parentElement.clientWidth - 4;
    canvas.height = 200;

    signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgba(255,255,255,0)',
        penColor: type === 'stamp' ? '#e74c3c' : '#000',
    });

    sigCallback = (dataUrl) => {
        fieldValues[fieldIdx] = dataUrl;
        const area = document.querySelector('.sig-area[data-idx="' + fieldIdx + '"]');
        if (area) {
            area.innerHTML = '<img src="' + dataUrl + '">';
            area.classList.add('filled');
        }

        /* 같은 라벨의 서명/도장 필드에도 자동 기입 */
        const srcField = ALL_FIELDS.find(f => f._idx === fieldIdx);
        if (srcField && srcField.label) {
            MY_FIELDS.forEach(f => {
                if (f._idx === fieldIdx) return;
                if (f.label !== srcField.label) return;
                if (f.type !== srcField.type) return;
                if (f.read_only) return;
                fieldValues[f._idx] = dataUrl;
                const otherArea = document.querySelector('.sig-area[data-idx="' + f._idx + '"]');
                if (otherArea) {
                    otherArea.innerHTML = '<img src="' + dataUrl + '">';
                    otherArea.classList.add('filled');
                }
            });
        }

        updateProgress();
    };
}

function clearSig() { if (signaturePad) signaturePad.clear(); }

function closeSigModal() {
    document.getElementById('sigModal').classList.remove('show');
    signaturePad = null;
    sigCallback = null;
}

function confirmSig() {
    if (!signaturePad || signaturePad.isEmpty()) {
        showToast('서명을 입력하세요.');
        return;
    }
    if (sigCallback) sigCallback(signaturePad.toDataURL());
    closeSigModal();
}

/* ============================================
   서명 확인 모달
   ============================================ */
function onSubmitClick() {
    if (!validateFields()) return;
    document.getElementById('confirmModal').classList.add('show');
}

function closeConfirmModal() {
    document.getElementById('confirmModal').classList.remove('show');
    /* 체크박스 리셋 */
    document.querySelectorAll('.confirm-agree-cb').forEach(cb => { cb.checked = false; });
    updateConfirmBtn();
}

function updateConfirmBtn() {
    const cbs = document.querySelectorAll('.confirm-agree-cb');
    const allChecked = cbs.length > 0 && Array.from(cbs).every(cb => cb.checked);
    const btn = document.getElementById('confirmSignBtn');
    if (btn) btn.disabled = !allChecked;
}

/* ============================================
   필드 유효성 검사
   ============================================ */
function validateFields() {
    for (const f of MY_FIELDS) {
        if (f.type === 'image') continue;
        if (f.read_only) continue;

        let value = '';
        if (f.type === 'text') {
            const input = document.querySelector('input[type="text"][data-idx="' + f._idx + '"]');
            value = input ? input.value.trim() : '';
        } else if (f.type === 'date') {
            const input = document.querySelector('input[type="date"][data-idx="' + f._idx + '"]');
            value = input ? input.value : '';
        } else if (f.type === 'signature' || f.type === 'stamp') {
            value = fieldValues[f._idx] || '';
        } else if (f.type === 'checkbox') {
            const cb = document.querySelector('input[type="checkbox"][data-idx="' + f._idx + '"]');
            value = cb && cb.checked ? 'Y' : '';
        }

        if (f.required && !value) {
            const label = f.label || TYPE_LABELS[f.type] || f.type;
            showToast(label + ' 항목을 입력해 주세요.');
            /* 해당 필드로 스크롤 */
            const fieldGroup = document.querySelector('[data-field-idx="' + f._idx + '"]');
            if (fieldGroup) fieldGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
        }
    }
    return true;
}

/* ============================================
   서명 제출
   ============================================ */
async function doSubmitSign() {
    /* 동의 체크 방어 검증 */
    const cbs = document.querySelectorAll('.confirm-agree-cb');
    if (!Array.from(cbs).every(cb => cb.checked)) {
        showToast('모든 약관에 동의해야 합니다.');
        return;
    }
    closeConfirmModal();

    const values = [];
    for (const f of MY_FIELDS) {
        let value = '';
        if (f.type === 'text') {
            const input = document.querySelector('input[type="text"][data-idx="' + f._idx + '"]');
            value = input ? input.value.trim() : '';
        } else if (f.type === 'date') {
            const input = document.querySelector('input[type="date"][data-idx="' + f._idx + '"]');
            value = input ? input.value : '';
        } else if (f.type === 'signature' || f.type === 'stamp') {
            value = fieldValues[f._idx] || '';
        } else if (f.type === 'checkbox') {
            const cb = document.querySelector('input[type="checkbox"][data-idx="' + f._idx + '"]');
            value = cb && cb.checked ? 'Y' : '';
        } else if (f.type === 'image') {
            value = f.default_value || '';
        }
        values.push({ field_idx: f._idx, value: value });
    }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span>처리중...</span>';

    try {
        const res = await fetch('/api/sign/' + SIGN_TOKEN, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN,
            },
            body: JSON.stringify({ field_values: values }),
        });
        const data = await res.json();
        if (data.success) {
            showToast('서명이 완료되었습니다!', 2000);
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.error || '서명 실패');
            btn.disabled = false;
            btn.innerHTML = '&#9997;&#65039; 서명 완료';
        }
    } catch (e) {
        showToast('오류가 발생했습니다. 다시 시도해 주세요.');
        btn.disabled = false;
        btn.innerHTML = '&#9997;&#65039; 서명 완료';
    }
}

/* ============================================
   초기화
   ============================================ */
document.addEventListener('DOMContentLoaded', function() {
    /* PDF 뷰어 로드 (서명 전/후 모두) */
    if (document.getElementById('pdfScrollContainer')) {
        loadPdf();
        initPinchZoom();
    }

    if (!ALREADY_SIGNED) {
        /* 읽기전용 필드의 기본값을 fieldValues에 세팅 */
        MY_FIELDS.forEach(f => {
            if (f.default_value) {
                fieldValues[f._idx] = f.default_value;
            }
        });
        renderFields();
    }
});
</script>
{% endblock %}
