{% extends "base_admin.html" %}

{% block admin_title %}HUMETIX - 서식 관리{% endblock %}
{% block page_title %}서식 관리{% endblock %}
{% block page_desc %}PDF 계약서를 업로드하고 필드를 배치하여 서식을 만듭니다.{% endblock %}

{% block page_css %}
.upload-card {
    background: var(--bg2);
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 40px 24px;
    text-align: center;
    margin-bottom: 24px;
    cursor: pointer;
    transition: border-color .2s, background .2s;
}
.upload-card:hover { border-color: var(--accent); background: var(--bg3); }
.upload-card.dragover { border-color: var(--primary); background: rgba(232,93,38,.06); }
.upload-card .upload-icon { font-size: 48px; margin-bottom: 12px; transition: transform .2s; }
.upload-card.dragover .upload-icon { transform: scale(1.15); }
.upload-card .upload-text { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
.upload-card .upload-hint { font-size: 13px; color: var(--text2); }
.action-btns { display: flex; gap: 4px; }
@media (max-width: 768px) {
    .upload-card { padding: 28px 16px; }
    .action-btns { flex-wrap: wrap; }
}
{% endblock %}

{% block content %}
<div class="upload-card" id="uploadArea">
    <div class="upload-icon" id="uploadIcon">&#128228;</div>
    <div class="upload-text" id="uploadText">PDF 파일을 여기에 끌어서 놓거나, 클릭하여 업로드</div>
    <div class="upload-hint">새 서식을 만들려면 PDF 계약서를 업로드하세요 (최대 20MB)</div>
    <input type="file" id="pdfInput" accept=".pdf" style="display:none">
</div>

<div class="table-wrap">
    <div class="table-header">
        <div class="table-title">서식 목록 ({{ templates|length }}개)</div>
    </div>
    <div class="table-scroll">
        <table>
            <thead>
                <tr>
                    <th>서식명</th>
                    <th>파일명</th>
                    <th>페이지</th>
                    <th>필드 수</th>
                    <th>계약 수</th>
                    <th>생성일</th>
                    <th>마지막 활동</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody id="templateBody">
                {% for t in templates %}
                <tr id="tpl-row-{{ t.id }}">
                    <td class="emp-name">{{ t.name }}</td>
                    <td>{{ t.file_original_name or '-' }}</td>
                    <td class="mono">{{ t.page_count }}p</td>
                    <td class="mono">{{ t.fields|length }}개</td>
                    <td class="mono">{{ t.contracts|length }}건</td>
                    <td class="mono">{{ t.created_at.strftime('%Y-%m-%d %H:%M:%S') if t.created_at else '-' }}</td>
                    <td class="mono">{{ t.updated_at.strftime('%Y-%m-%d %H:%M:%S') if t.updated_at else '-' }}</td>
                    <td>
                        <div class="action-btns">
                            <a href="/admin/contract-templates/{{ t.id }}/edit" class="btn btn-primary btn-sm">편집</a>
                            <button class="btn btn-outline btn-sm" onclick="replaceFile({{ t.id }})">문서 교체</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTemplate({{ t.id }}, '{{ t.name }}')">삭제</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% if not templates %}
                <tr>
                    <td colspan="8" style="text-align:center;padding:24px;color:var(--text2);">
                        등록된 서식이 없습니다. PDF를 업로드하여 서식을 만드세요.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<input type="file" id="replaceInput" accept=".pdf" style="display:none">
{% endblock %}

{% block page_js %}
const csrfToken = window.csrfToken;
const headers = { 'X-CSRFToken': csrfToken };
let replaceTargetId = null;

const uploadArea = document.getElementById('uploadArea');
const pdfInput = document.getElementById('pdfInput');

/* 클릭 업로드 */
uploadArea.addEventListener('click', () => pdfInput.click());

/* 드래그 & 드롭 */
['dragenter', 'dragover'].forEach(ev =>
    uploadArea.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); uploadArea.classList.add('dragover'); })
);
['dragleave', 'drop'].forEach(ev =>
    uploadArea.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); uploadArea.classList.remove('dragover'); })
);
uploadArea.addEventListener('drop', (e) => {
    const file = e.dataTransfer.files[0];
    if (file) uploadFile(file);
});

pdfInput.addEventListener('change', function() {
    if (this.files[0]) uploadFile(this.files[0]);
    this.value = '';
});

async function uploadFile(file) {
    if (!file.name.toLowerCase().endsWith('.pdf')) {
        showToast('PDF 파일만 업로드 가능합니다.');
        return;
    }
    if (file.size > 20 * 1024 * 1024) {
        showToast('파일 크기는 20MB 이하만 가능합니다.');
        return;
    }

    const fd = new FormData();
    fd.append('file', file);
    fd.append('csrf_token', csrfToken);

    uploadArea.style.opacity = '0.5';
    document.getElementById('uploadIcon').innerHTML = '&#9203;';
    document.getElementById('uploadText').textContent = '업로드 중...';

    try {
        const res = await fetch('/api/contract-templates', { method: 'POST', headers, body: fd });
        const data = await res.json();
        if (data.success && data.redirect) {
            showToast('서식이 생성되었습니다.');
            location.href = data.redirect;
        } else {
            showToast(data.error || '업로드 실패');
        }
    } catch (e) {
        showToast('업로드 중 오류가 발생했습니다.');
    } finally {
        uploadArea.style.opacity = '1';
        document.getElementById('uploadIcon').innerHTML = '&#128228;';
        document.getElementById('uploadText').textContent = 'PDF 파일을 여기에 끌어서 놓거나, 클릭하여 업로드';
    }
}

function replaceFile(tid) {
    replaceTargetId = tid;
    document.getElementById('replaceInput').click();
}

document.getElementById('replaceInput').addEventListener('change', async function() {
    const file = this.files[0];
    if (!file || !replaceTargetId) return;

    const fd = new FormData();
    fd.append('file', file);
    fd.append('csrf_token', csrfToken);

    try {
        const res = await fetch('/api/contract-templates/' + replaceTargetId + '/duplicate-with-pdf', {
            method: 'POST', headers, body: fd
        });
        const data = await res.json();
        if (data.success && data.redirect) {
            showToast('새 서식이 생성되었습니다. 필드를 확인하세요.');
            location.href = data.redirect;
        } else {
            showToast(data.error || '문서 교체 실패');
        }
    } catch (e) {
        showToast('문서 교체 중 오류가 발생했습니다.');
    } finally {
        this.value = '';
        replaceTargetId = null;
    }
});

function deleteTemplate(tid, name) {
    showConfirm('"' + name + '" 서식을 삭제하시겠습니까?', async () => {
        const res = await fetch('/api/contract-templates/' + tid, {
            method: 'DELETE', headers: { ...headers, 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (data.success) {
            showToast('서식이 삭제되었습니다.');
            document.getElementById('tpl-row-' + tid).remove();
        } else {
            showToast(data.error || '삭제 실패');
        }
    });
}
{% endblock %}
