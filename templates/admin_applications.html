{% extends "base_admin.html" %}

{% block admin_title %}HUMETIX - 지원자 관리{% endblock %}
{% block page_title %}지원자 관리{% endblock %}
{% block page_desc %}지원자 현황을 조회하고 관리합니다.{% endblock %}

{% block page_css %}
/* ── Filter section ── */
.filter-section {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 18px;
}
.search-row {
    display: grid;
    grid-template-columns: minmax(280px, 1fr);
    gap: 10px;
    align-items: end;
    margin-bottom: 12px;
}
.search-field { width: 100%; }
.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
}
.filter-actions {
    margin-top: 14px;
    display: flex;
    justify-content: center;
    gap: 8px;
    flex-wrap: wrap;
}
.filter-group-title {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--text2);
    margin-bottom: 8px;
    display: block;
}

/* ── Results bar ── */
.results-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}
.total-count {
    font-size: 1.2rem;
    margin: 0;
    font-weight: 700;
}
.empty-state {
    text-align: center;
    padding: 64px 20px;
    color: var(--text2);
    border: 1px dashed var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg3);
}

/* ── Applicant grid (container query) ── */
.applicant-grid-wrap {
    container-type: inline-size;
}
.applicant-grid {
    display: grid;
    grid-template-columns: minmax(0, 1fr);
    gap: 14px;
}

/* ── Form controls (local overrides) ── */
.form-control {
    height: 38px;
    padding: 6px 12px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.95rem;
    font-family: inherit;
    background: var(--bg);
    color: var(--text);
}
.form-control:focus {
    border-color: var(--accent);
    outline: none;
    box-shadow: 0 0 0 3px rgba(232,93,38,.1);
}

/* ── Card / applicant ── */
.card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    margin-bottom: 0;
    box-shadow: var(--shadow);
    position: relative;
    container-type: inline-size;
}
.applicant-grid > .card { min-width: 0; }
.card-header {
    background: var(--bg3);
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    border-radius: 8px 8px 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.card-body {
    padding: 18px;
    display: flex;
    gap: 18px;
    align-items: flex-start;
}

.applicant-photo {
    width: 120px;
    height: 160px;
    background: var(--bg3);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text2);
    font-size: 0.8rem;
    flex-shrink: 0;
}
.applicant-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.applicant-info { flex: 1; min-width: 0; }
.info-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}
.info-columns .left-group  { max-width: 420px; }
.info-columns .right-group { max-width: 420px; }
.info-columns .right-group .info-block-title:first-of-type { margin-top: 0; }

.info-block-title {
    margin: 6px 0 10px 0;
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--text2);
    letter-spacing: 0.2px;
    text-transform: uppercase;
}
.info-grid {
    display: grid;
    grid-template-columns: 90px 1fr;
    row-gap: 8px;
    column-gap: 10px;
}
.info-label {
    font-weight: 600;
    color: var(--text2);
}
.info-value {
    color: var(--text);
    word-break: break-word;
}
.info-value .info-multiline {
    display: block;
    line-height: 1.6;
}
.info-divider {
    height: 1px;
    background: var(--border);
    margin: 12px 0;
}
.info-row {
    margin-bottom: 8px;
    font-size: 0.95rem;
    line-height: 1.5;
}
.info-group-title {
    margin: 8px 0 6px 0;
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--text2);
    letter-spacing: 0.2px;
    text-transform: uppercase;
}

.label-badge {
    display: inline-block;
    width: 70px;
    font-weight: 600;
    color: var(--text2);
}
.data-val { color: var(--text); }
.highlight {
    color: var(--accent);
    font-weight: 600;
}

/* ── Career table ── */
.career-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 0.9rem;
}
.career-table th {
    background: var(--bg3);
    color: var(--text2);
    padding: 8px;
    border: 1px solid var(--border);
}
.career-table td {
    padding: 8px;
    border: 1px solid var(--border);
    text-align: center;
}

/* ── Memo box ── */
.memo-box {
    margin-top: 15px;
    padding: 15px;
    background: #fffcf0;
    border: 1px dashed #e0dcbf;
    border-radius: 6px;
}
.memo-textarea {
    width: 100%;
    height: 50px;
    border: 1px solid #e0dcbf;
    background: transparent;
    resize: none;
    padding: 5px;
    font-size: 0.9rem;
    font-family: inherit;
    color: var(--text);
}

/* ── Pagination ── */
.pagination {
    display: flex;
    justify-content: center;
    gap: 5px;
    margin-top: 30px;
}
.page-link {
    display: inline-flex;
    width: 36px;
    height: 36px;
    justify-content: center;
    align-items: center;
    border: 1px solid var(--border);
    color: var(--accent);
    background: var(--bg2);
    border-radius: 4px;
    text-decoration: none;
    font-weight: 600;
}
.page-link.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
}
.page-link:hover:not(.active) {
    background: var(--bg3);
}

/* ── Status badge variants ── */
.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
}
.status-badge.new       { background: #e0e7ff; color: #4338ca; }
.status-badge.review    { background: #fef3c7; color: #b45309; }
.status-badge.interview { background: #dbeafe; color: #1d4ed8; }
.status-badge.offer     { background: #f3e8ff; color: #7c3aed; }
.status-badge.hired     { background: #dcfce7; color: #16a34a; }
.status-badge.rejected  { background: #fee2e2; color: var(--danger); }

/* ── Excel column modal ── */
.excel-modal-card {
    max-width: 640px;
}
.excel-modal-help {
    color: var(--text2);
    font-size: 0.9rem;
    margin-bottom: 12px;
}
.excel-modal-actions {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}
.excel-column-list {
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg);
    max-height: 360px;
    overflow-y: auto;
    padding: 8px;
}
.excel-column-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 10px;
    align-items: center;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 10px;
    background: var(--bg2);
}
.excel-column-row + .excel-column-row {
    margin-top: 8px;
}
.excel-column-label {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text);
    font-size: 0.95rem;
}
.excel-column-order {
    display: flex;
    gap: 6px;
}
.excel-order-btn {
    width: 30px;
    height: 30px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg2);
    color: var(--text);
    cursor: pointer;
}
.excel-order-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.excel-selected-count {
    margin-top: 10px;
    color: var(--text2);
    font-size: 0.85rem;
}
.excel-modal-footer {
    margin-top: 14px;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}

/* ── 2-column layout (container query) ── */
@container (min-width: 1200px) {
    .applicant-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
    }
}

/* ── Card body collapses when card is narrow ── */
@container (max-width: 760px) {
    .card-body {
        flex-direction: column;
        gap: 14px;
    }
    .applicant-photo {
        width: 132px;
        height: 176px;
    }
    .info-columns {
        grid-template-columns: 1fr;
    }
}

/* ── Fallback for browsers without container query support ── */
@supports not (container-type: inline-size) {
    @media (min-width: 1520px) {
        .applicant-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }
}

/* ── Responsive ── */
@media (max-width: 1100px) {
    .info-columns .left-group,
    .info-columns .right-group {
        max-width: none;
    }
}
@media (max-width: 900px) {
    .info-columns {
        grid-template-columns: 1fr;
    }
}
@media (max-width: 820px) {
    .search-row {
        grid-template-columns: 1fr;
    }
}
{% endblock %}

{% block content %}
{% set status_labels = {'new':'신규','review':'검토','interview':'면접','offer':'오퍼','hired':'합격','rejected':'불합격'} %}

<div class="filter-section">
    <form id="searchForm" action="{{ url_for('admin.applications') }}" method="get">
        <div class="search-row">
            <div class="search-field">
                <input type="text" name="q" class="form-control" placeholder="이름 또는 연락처 검색"
                    value="{{ search_query }}">
                <input type="hidden" name="type" value="name">
            </div>
        </div>

        <div class="filters-grid">
            <div>
                <label class="filter-group-title">성별</label>
                <select name="gender" class="form-select">
                    <option value="">전체</option>
                    <option value="남자" {% if filters.gender=='남자' %}selected{% endif %}>남자</option>
                    <option value="여자" {% if filters.gender=='여자' %}selected{% endif %}>여자</option>
                </select>
            </div>
            <div>
                <label class="filter-group-title">근무형태</label>
                <select name="shift" class="form-select">
                    <option value="">전체</option>
                    <option value="주간" {% if filters.shift=='주간' %}selected{% endif %}>주간</option>
                    <option value="2교대" {% if filters.shift=='2교대' %}selected{% endif %}>2교대</option>
                </select>
            </div>
            <div>
                <label class="filter-group-title">근무방식</label>
                <select name="posture" class="form-select">
                    <option value="">전체</option>
                    <option value="무관" {% if filters.posture=='무관' %}selected{% endif %}>무관</option>
                    <option value="좌식" {% if filters.posture=='좌식' %}selected{% endif %}>좌식</option>
                    <option value="입식" {% if filters.posture=='입식' %}selected{% endif %}>입식</option>
                </select>
            </div>
            <div>
                <label class="filter-group-title">잔업</label>
                <select name="overtime" class="form-select">
                    <option value="">전체</option>
                    <option value="가능" {% if filters.overtime=='가능' %}selected{% endif %}>가능</option>
                    <option value="불가능" {% if filters.overtime=='불가능' %}selected{% endif %}>불가능</option>
                </select>
            </div>
            <div>
                <label class="filter-group-title">특근</label>
                <select name="holiday" class="form-select">
                    <option value="">전체</option>
                    <option value="가능" {% if filters.holiday=='가능' %}selected{% endif %}>가능</option>
                    <option value="불가능" {% if filters.holiday=='불가능' %}selected{% endif %}>불가능</option>
                </select>
            </div>
            <div>
                <label class="filter-group-title">상태</label>
                <select name="status" class="form-select">
                    <option value="">전체</option>
                    {% for val in status_options %}
                    <option value="{{ val }}" {% if filters.status==val %}selected{% endif %}>{{ status_labels[val] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="filter-group-title">가불 희망</label>
                <select name="advance_pay" class="form-select">
                    <option value="">전체</option>
                    <option value="희망" {% if filters.advance_pay=='희망' %}selected{% endif %}>희망</option>
                    <option value="비희망" {% if filters.advance_pay=='비희망' %}selected{% endif %}>비희망</option>
                </select>
            </div>
            <div>
                <label class="filter-group-title">급여 형태</label>
                <select name="insurance_type" class="form-select">
                    <option value="">전체</option>
                    <option value="3.3%" {% if filters.insurance_type=='3.3%' %}selected{% endif %}>3.3%</option>
                    <option value="4대보험" {% if filters.insurance_type=='4대보험' %}selected{% endif %}>4대보험</option>
                </select>
            </div>
            <div>
                <label class="filter-group-title">접수기간 (시작)</label>
                <input type="date" name="start_date" class="form-control" value="{{ start_date or '' }}">
            </div>
            <div>
                <label class="filter-group-title">접수기간 (종료)</label>
                <input type="date" name="end_date" class="form-control" value="{{ end_date or '' }}">
            </div>
        </div>

        <div class="filter-actions">
            <button type="submit" class="btn btn-primary" style="width: 200px;">조건 검색</button>
            <a href="{{ url_for('admin.applications') }}" class="btn btn-outline">초기화</a>
        </div>
    </form>
</div>

<div class="results-bar">
    <h3 class="total-count">
        총 <span style="color: var(--accent);">{{ pagination.total }}</span>명 지원
    </h3>
    <div style="display: flex; gap: 8px; align-items: center;">
        <button type="button" class="btn btn-success btn-sm" id="openExcelColumnModalBtn">엑셀 내보내기</button>
        <button type="button" class="btn btn-primary btn-sm" id="downloadApplicationFormBtn">입사지원서 다운로드</button>
        <button onclick="showConfirm('선택한 항목을 삭제하시겠습니까?').then(ok => { if(ok) document.getElementById('deleteForm').submit(); });"
            class="btn btn-danger btn-sm">선택 삭제</button>
    </div>
</div>

<form method="post" action="{{ url_for('admin.delete_selected') }}" id="deleteForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    {% if not data %}
    <div class="empty-state">
        접수된 지원서가 없거나 검색 결과가 없습니다.
    </div>
    {% endif %}

    <div class="applicant-grid-wrap">
    <div class="applicant-grid">
    {% for entry in data %}
    <div class="card">
        <div class="card-header">
            <div style="display: flex; align-items: center;">
                <input type="checkbox" name="selected_ids" value="{{ entry.id }}"
                    style="transform: scale(1.2); margin-right: 12px;">
                <span style="font-weight: 700; font-size: 1.1rem; margin-right: 8px;">{{ entry.info.name }}</span>

                {% if entry.info.gender == '남자' %}
                <span class="badge" style="background-color: #007bff;">남</span>
                {% elif entry.info.gender == '여자' %}
                <span class="badge" style="background-color: #dc3545;">여</span>
                {% endif %}

                <span style="color: var(--text2); font-size: 0.85rem; margin-left: auto;">
                    접수일: {{ entry.timestamp }}
                </span>
            </div>
        </div>

        <div class="card-body">
            {% if entry.photo %}
            <div class="applicant-photo">
                <a href="/view_photo/{{ entry.photo }}" target="_blank">
                    <img src="/view_photo/{{ entry.photo }}">
                </a>
            </div>
            {% else %}
            <div class="applicant-photo">사진없음</div>
            {% endif %}

            <div class="applicant-info">
                <div class="info-columns">
                    <div class="left-group">
                        <div class="info-block-title">기본정보</div>
                        <div class="info-grid">
                            <div class="info-label">생년월일</div>
                            <div class="info-value">{{ entry.info.birth }}</div>
                            <div class="info-label">연락처</div>
                            <div class="info-value">{{ entry.info.phone }}</div>
                            <div class="info-label">이메일</div>
                            <div class="info-value">{{ entry.info.email or '-' }}</div>
                            <div class="info-label">주소</div>
                            <div class="info-value">{{ entry.info.address }}</div>
                            <div class="info-label">사진</div>
                            <div class="info-value">{{ "있음" if entry.photo else "없음" }}</div>
                        </div>
                        <div class="info-divider"></div>
                        <div class="info-block-title">신체/사이즈</div>
                        <div class="info-grid">
                            <div class="info-label">신체</div>
                            <div class="info-value">{{ entry.body.height or '-' }}cm / {{ entry.body.weight or '-' }}kg</div>
                            <div class="info-label">시력</div>
                            <div class="info-value">{{ entry.body.vision or '-' }}</div>
                            <div class="info-label">사이즈</div>
                            <div class="info-value">신발: {{ entry.body.shoes or '-' }} / 티셔츠: {{ entry.body.tshirt or '-' }}</div>
                        </div>
                    </div>
                    <div class="right-group">
                        <div class="info-block-title">근무/희망</div>
                        <div class="info-grid">
                            <div class="info-label">근무</div>
                            <div class="info-value">
                                <span class="info-multiline">형태: {{ entry.work_condition.shift or '-' }}</span>
                                <span class="info-multiline">방식: {{ entry.work_condition.posture or '-' }}</span>
                                <span class="info-multiline">잔업: {{ entry.work_condition.overtime or '-' }}</span>
                                <span class="info-multiline">특근: {{ entry.work_condition.holiday or '-' }}</span>
                            </div>
                            <div class="info-label">희망</div>
                            <div class="info-value">
                                <span class="info-multiline">가불: {{ entry.extra.advance_pay or '-' }}</span>
                                <span class="info-multiline">급여: {{ entry.extra.insurance_type or '-' }}</span>
                            </div>
                        </div>
                        <div class="info-divider"></div>
                        <div class="info-block-title">일정/상태</div>
                        <div class="info-grid">
                            <div class="info-label">일정</div>
                            <div class="info-value">
                                <span class="highlight">면접: {{ entry.work_condition.interview_date or '미정' }}</span>
                                /
                                <span class="highlight">입사: {{ entry.work_condition.start_date or '미정' }}</span>
                            </div>
                            <div class="info-label">상태</div>
                            <div class="info-value" style="display:flex; align-items:center; gap:8px;">
                                <select id="status-{{ entry.id }}" class="form-select"
                                    style="width: 160px; height: 32px;">
                                    {% for val in status_options %}
                                    <option value="{{ val }}" {% if entry.status==val %}selected{% endif %}>{{ status_labels[val] }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" id="btn-status-{{ entry.id }}" class="btn btn-sm"
                                    style="height: 32px; font-size: 0.8rem; padding: 0 10px; background: var(--text2); color: #fff;"
                                    onclick="saveStatus('{{ entry.id }}')">저장</button>
                            </div>
                        </div>
                    </div>
                </div>

                <table class="career-table">
                    <thead>
                        <tr>
                            <th style="width: 20%;">회사명</th>
                            <th style="width: 25%;">기간</th>
                            <th style="width: 20%;">업무</th>
                            <th style="width: 35%;">퇴사사유</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if entry.career %}
                        {% for car in entry.career %}
                        <tr>
                            <td>{{ car.company }}</td>
                            <td>{{ car.start }}~{{ car.end }}</td>
                            <td>{{ car.role }}</td>
                            <td>{{ car.reason }}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="4" style="color: var(--text2);">경력 사항 없음</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>

                <div class="memo-box">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div style="font-weight: 700; font-size: 0.85rem; color: var(--text2);">관리자 메모</div>
                        <button type="button" id="btn-memo-{{ entry.id }}" onclick="saveMemo('{{ entry.id }}')"
                            class="btn btn-sm"
                            style="height: 28px; font-size: 0.8rem; padding: 0 10px; background: var(--text2); color: #fff;">저장</button>
                    </div>
                    <textarea id="memo-{{ entry.id }}" class="memo-textarea"
                        placeholder="특이사항 입력">{{ entry.memo }}</textarea>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    </div>
    </div>
</form>

<!-- 엑셀 컬럼 선택 모달 -->
<div class="modal-overlay" id="excelColumnModal">
    <div class="modal-card excel-modal-card">
        <h3>엑셀 내보내기 컬럼 선택</h3>
        <p class="excel-modal-help">선택한 컬럼만 포함해 다운로드합니다. 순서는 위/아래 버튼으로 조정할 수 있습니다.</p>

        <div class="excel-modal-actions">
            <button type="button" class="btn btn-outline btn-sm" id="selectAllExcelColumnsBtn">전체 선택</button>
            <button type="button" class="btn btn-outline btn-sm" id="clearAllExcelColumnsBtn">전체 해제</button>
        </div>

        <div class="excel-column-list" id="excelColumnList"></div>
        <p class="excel-selected-count" id="excelSelectedCount"></p>

        <div class="excel-modal-footer">
            <button type="button" class="btn btn-outline btn-sm" id="closeExcelColumnModalBtn">취소</button>
            <button type="button" class="btn btn-success btn-sm" id="downloadSelectedExcelBtn">다운로드</button>
        </div>
    </div>
</div>

{% if pagination.total > 0 %}
<div class="pagination">
    {% if pagination.has_prev %}
    <a href="javascript:goPage({{ pagination.prev_num }})" class="page-link">&#8249;</a>
    {% endif %}

    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
    {% if page_num %}
    {% if page_num == pagination.page %}
    <span class="page-link active">{{ page_num }}</span>
    {% else %}
    <a href="javascript:goPage({{ page_num }})" class="page-link">{{ page_num }}</a>
    {% endif %}
    {% else %}
    <span class="page-link" style="border:none;">...</span>
    {% endif %}
    {% endfor %}

    {% if pagination.has_next %}
    <a href="javascript:goPage({{ pagination.next_num }})" class="page-link">&#8250;</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block page_js %}
const csrfToken = window.csrfToken || '{{ csrf_token() }}';
const currentQueryString = {{ query_string|tojson }};
const excelColumnStorageKey = 'humetix_admin_excel_columns_v1';
const excelColumnDefinitions = [
    { key: 'name',           label: '이름' },
    { key: 'phone',          label: '연락처' },
    { key: 'email',          label: '이메일' },
    { key: 'address',        label: '희망지역/주소' },
    { key: 'status',         label: '상태' },
    { key: 'submitted_at',   label: '접수일' },
    { key: 'gender',         label: '성별' },
    { key: 'birth',          label: '생년월일' },
    { key: 'shift',          label: '근무형태' },
    { key: 'posture',        label: '근무방식' },
    { key: 'overtime',       label: '잔업' },
    { key: 'holiday',        label: '특근' },
    { key: 'advance_pay',    label: '가불여부' },
    { key: 'insurance_type', label: '급여형태' },
    { key: 'interview_date', label: '면접일' },
    { key: 'start_date',     label: '출근가능일' },
    { key: 'memo',           label: '관리자메모' }
];
const defaultExcelColumnKeys = ['name', 'phone', 'email', 'address', 'status', 'submitted_at'];
let excelColumnsState = [];

function toggleAll(source) {
    document.getElementsByName('selected_ids').forEach(checkbox => {
        checkbox.checked = source.checked;
    });
}

function goPage(page) {
    const form = document.getElementById('searchForm');
    let pageInput = form.querySelector('input[name="page"]');
    if (!pageInput) {
        pageInput = document.createElement('input');
        pageInput.type = 'hidden';
        pageInput.name = 'page';
        form.appendChild(pageInput);
    }
    pageInput.value = page;
    form.submit();
}

function normalizeExcelColumnState(savedState) {
    const knownKeys = new Set(excelColumnDefinitions.map((c) => c.key));
    const savedOrder    = Array.isArray(savedState?.order)    ? savedState.order    : [];
    const savedSelected = Array.isArray(savedState?.selected) ? savedState.selected : [];

    const orderedKeys = [];
    savedOrder.forEach((key) => {
        if (knownKeys.has(key) && !orderedKeys.includes(key)) orderedKeys.push(key);
    });
    excelColumnDefinitions.forEach((c) => {
        if (!orderedKeys.includes(c.key)) orderedKeys.push(c.key);
    });

    const selectedSet = new Set(
        (savedSelected.length ? savedSelected : defaultExcelColumnKeys).filter((k) => knownKeys.has(k))
    );

    return orderedKeys.map((key) => {
        const base = excelColumnDefinitions.find((c) => c.key === key);
        return { key: base.key, label: base.label, selected: selectedSet.has(key) };
    });
}

function loadExcelColumnState() {
    try {
        const raw = localStorage.getItem(excelColumnStorageKey);
        return normalizeExcelColumnState(raw ? JSON.parse(raw) : null);
    } catch (e) {
        return normalizeExcelColumnState(null);
    }
}

function saveExcelColumnState() {
    try {
        localStorage.setItem(excelColumnStorageKey, JSON.stringify({
            order:    excelColumnsState.map((c) => c.key),
            selected: excelColumnsState.filter((c) => c.selected).map((c) => c.key)
        }));
    } catch (e) { /* localStorage 불가 환경 무시 */ }
}

function renderExcelColumnList() {
    const list = document.getElementById('excelColumnList');
    if (!list) return;
    list.innerHTML = '';
    excelColumnsState.forEach((col, idx) => {
        const row = document.createElement('div');
        row.className = 'excel-column-row';
        row.innerHTML = `
            <label class="excel-column-label">
                <input type="checkbox" data-role="toggle" data-key="${col.key}" ${col.selected ? 'checked' : ''}>
                <span>${col.label}</span>
            </label>
            <div class="excel-column-order">
                <button type="button" class="excel-order-btn" data-role="move-up"   data-index="${idx}" ${idx === 0 ? 'disabled' : ''}>↑</button>
                <button type="button" class="excel-order-btn" data-role="move-down" data-index="${idx}" ${idx === excelColumnsState.length - 1 ? 'disabled' : ''}>↓</button>
            </div>`;
        list.appendChild(row);
    });
    const count = excelColumnsState.filter((c) => c.selected).length;
    const el = document.getElementById('excelSelectedCount');
    if (el) el.textContent = `선택된 컬럼: ${count}개`;
}

function moveExcelColumn(from, to) {
    if (to < 0 || to >= excelColumnsState.length) return;
    const [moved] = excelColumnsState.splice(from, 1);
    excelColumnsState.splice(to, 0, moved);
    saveExcelColumnState();
    renderExcelColumnList();
}

function openExcelColumnModal() {
    excelColumnsState = loadExcelColumnState();
    renderExcelColumnList();
    document.getElementById('excelColumnModal').classList.add('show');
}

function closeExcelColumnModal() {
    document.getElementById('excelColumnModal').classList.remove('show');
}

function downloadSelectedExcelColumns() {
    const selectedKeys = excelColumnsState.filter((c) => c.selected).map((c) => c.key);
    if (!selectedKeys.length) {
        showToast('최소 1개 컬럼을 선택해 주세요.');
        return;
    }
    saveExcelColumnState();
    const params = new URLSearchParams(currentQueryString || '');
    params.delete('page');
    params.set('excel_columns', selectedKeys.join(','));
    window.location.href = `/download_excel?${params.toString()}`;
    closeExcelColumnModal();
}

/* 입사지원서 다운로드 (템플릿 형식) */
document.getElementById('downloadApplicationFormBtn').addEventListener('click', () => {
    const params = new URLSearchParams(currentQueryString || '');
    params.delete('page');
    params.delete('excel_columns');
    window.location.href = `/download_excel?${params.toString()}`;
});

/* 엑셀 모달 이벤트 */
const excelColumnModal        = document.getElementById('excelColumnModal');
const excelColumnList         = document.getElementById('excelColumnList');

document.getElementById('openExcelColumnModalBtn').addEventListener('click', openExcelColumnModal);
document.getElementById('closeExcelColumnModalBtn').addEventListener('click', closeExcelColumnModal);
document.getElementById('downloadSelectedExcelBtn').addEventListener('click', downloadSelectedExcelColumns);

document.getElementById('selectAllExcelColumnsBtn').addEventListener('click', () => {
    excelColumnsState = excelColumnsState.map((c) => ({ ...c, selected: true }));
    saveExcelColumnState();
    renderExcelColumnList();
});
document.getElementById('clearAllExcelColumnsBtn').addEventListener('click', () => {
    excelColumnsState = excelColumnsState.map((c) => ({ ...c, selected: false }));
    saveExcelColumnState();
    renderExcelColumnList();
});

excelColumnModal.addEventListener('click', (e) => {
    if (e.target === excelColumnModal) closeExcelColumnModal();
});
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && excelColumnModal.classList.contains('show')) closeExcelColumnModal();
});

excelColumnList.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-role]');
    if (!btn) return;
    const idx = Number(btn.dataset.index);
    if (btn.dataset.role === 'move-up')   moveExcelColumn(idx, idx - 1);
    if (btn.dataset.role === 'move-down') moveExcelColumn(idx, idx + 1);
});
excelColumnList.addEventListener('change', (e) => {
    const cb = e.target.closest('input[data-role="toggle"]');
    if (!cb) return;
    excelColumnsState = excelColumnsState.map((c) =>
        c.key === cb.dataset.key ? { ...c, selected: cb.checked } : c
    );
    saveExcelColumnState();
    renderExcelColumnList();
});

/* 메모 저장 */
async function saveMemo(appId) {
    const memoText = document.getElementById(`memo-${appId}`).value;
    const btn = document.getElementById(`btn-memo-${appId}`);
    const originalText = btn.innerText;
    btn.innerText = '저장중..';
    btn.disabled = true;

    const formData = new FormData();
    formData.append('memo', memoText);
    formData.append('csrf_token', csrfToken);

    try {
        const res = await fetch(`/update_memo/${appId}`, { method: 'POST', body: formData });
        const result = await res.json();
        if (result.success) {
            showToast('메모가 저장되었습니다.');
            btn.innerText = '완료';
            btn.style.background = 'var(--success)';
            setTimeout(() => { btn.innerText = originalText; btn.style.background = ''; btn.disabled = false; }, 1500);
        } else {
            showToast('실패: ' + result.message);
            btn.disabled = false;
            btn.innerText = originalText;
        }
    } catch (e) {
        showToast('오류가 발생했습니다.');
        btn.disabled = false;
        btn.innerText = originalText;
    }
}

/* 상태 저장 */
async function saveStatus(appId) {
    const statusVal = document.getElementById(`status-${appId}`).value;
    const btn = document.getElementById(`btn-status-${appId}`);
    const originalText = btn.innerText;
    btn.innerText = '저장중..';
    btn.disabled = true;

    const formData = new FormData();
    formData.append('status', statusVal);
    formData.append('csrf_token', csrfToken);

    try {
        const res = await fetch(`/update_status/${appId}`, { method: 'POST', body: formData });
        const result = await res.json();
        if (result.success) {
            showToast('상태가 변경되었습니다.');
            btn.innerText = '완료';
            btn.style.background = 'var(--success)';
            setTimeout(() => { btn.innerText = originalText; btn.style.background = ''; btn.disabled = false; }, 1500);
        } else {
            showToast('실패: ' + result.message);
            btn.disabled = false;
            btn.innerText = originalText;
        }
    } catch (e) {
        showToast('오류가 발생했습니다.');
        btn.disabled = false;
        btn.innerText = originalText;
    }
}
{% endblock %}
