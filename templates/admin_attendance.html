{% extends "base_admin.html" %}

{% block admin_title %}HUMETIX - 근무현황 관리{% endblock %}
{% block page_title %}근무현황 관리 (관리자){% endblock %}
{% block page_desc %}아래 통계는 현재 조회 조건의 기록 기준입니다.{% endblock %}

{% block page_css %}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 14px; margin-bottom: 24px;
}
.stat-card {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 18px;
    transition: transform .2s, box-shadow .2s;
}
.stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
.stat-label {
    font-size: 13px; color: var(--text2); font-weight: 500;
    text-transform: uppercase; letter-spacing: .5px; margin-bottom: 8px;
}
.stat-value {
    font-size: 30px; font-weight: 800;
    font-family: "Inter", system-ui, sans-serif; font-variant-numeric: tabular-nums;
    letter-spacing: -1px;
}
.stat-main { display: inline-flex; align-items: baseline; gap: 6px; }
.stat-unit { font-size: 16px; font-weight: 700; color: var(--text2); letter-spacing: 0; }
table { font-size: 15px !important; }
table thead th { font-size: 13px !important; padding: 14px 18px !important; }
table tbody td { padding: 14px 18px !important; font-size: 15px !important; }
table tbody td.mono {
    font-family: "Inter", system-ui, sans-serif;
    font-variant-numeric: tabular-nums; font-size: 15px !important;
}
table tbody td.emp-name { font-size: 15px !important; font-weight: 700; }
td.col-total { font-weight: 700; color: var(--text); }
td.col-ot { font-weight: 700; color: var(--success); }
td.col-night { font-weight: 700; color: var(--night); }
td.col-holiday { font-weight: 700; color: #d946ef; }
.badge { font-size: 12.5px !important; padding: 4px 12px !important; }
.filter-bar .form-input, .filter-bar select { font-size: 14px !important; padding: 9px 14px !important; }
.table-title { font-size: 16px !important; }
.stat-value.accent { color: var(--accent); }
.stat-value.success { color: var(--success); }
.stat-value.night { color: var(--night); }
.stat-sub { font-size: 12px; color: var(--text2); margin-top: 4px; }
.stat-sub:empty { display: none; }
.badge-day { background: var(--accent-bg); color: var(--accent); }
.badge-night { background: var(--night-bg); color: var(--night); }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-label-block { display: block; font-size: 12px; font-weight: 600; color: var(--text2); margin-bottom: 4px; }
@media (max-width: 768px) {
    .form-grid { grid-template-columns: 1fr; }
}
{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">기록 수</div>
        <div class="stat-main"><div class="stat-value">{{ stats.total }}</div><div class="stat-unit">건</div></div>
    </div>
    <div class="stat-card">
        <div class="stat-label">주간 근무</div>
        <div class="stat-main"><div class="stat-value accent">{{ stats.day }}</div><div class="stat-unit">건</div></div>
    </div>
    <div class="stat-card">
        <div class="stat-label">야간 근무</div>
        <div class="stat-main"><div class="stat-value night">{{ stats.night }}</div><div class="stat-unit">건</div></div>
    </div>
    <div class="stat-card">
        <div class="stat-label">총 근무</div>
        <div class="stat-main"><div class="stat-value">{{ stats.total_work }}</div><div class="stat-unit">시간</div></div>
    </div>
    <div class="stat-card">
        <div class="stat-label">잔업</div>
        <div class="stat-main"><div class="stat-value success">{{ stats.total_ot }}</div><div class="stat-unit">시간</div></div>
    </div>
    <div class="stat-card">
        <div class="stat-label">심야</div>
        <div class="stat-main"><div class="stat-value night">{{ stats.total_night }}</div><div class="stat-unit">시간</div></div>
    </div>
    <div class="stat-card">
        <div class="stat-label">특근</div>
        <div class="stat-main"><div class="stat-value" style="color:#d946ef">{{ stats.total_holiday }}</div><div class="stat-unit">시간</div></div>
    </div>
</div>

<form method="get" action="/admin/attendance" class="filter-bar">
    <input type="date" name="start_date" class="form-input" value="{{ start_date }}">
    <span style="color:var(--text2)">~</span>
    <input type="date" name="end_date" class="form-input" value="{{ end_date }}">
    <input type="text" name="emp_name" class="form-input" value="{{ emp_name }}" placeholder="이름" style="width:160px;min-width:0">
    <select name="work_type" class="form-input" style="width:120px;min-width:0">
        <option value="">전체</option>
        <option value="normal" {{ 'selected' if work_type == 'normal' }}>주간</option>
        <option value="night" {{ 'selected' if work_type == 'night' }}>야간</option>
        <option value="annual" {{ 'selected' if work_type == 'annual' }}>연차</option>
        <option value="absent" {{ 'selected' if work_type == 'absent' }}>결근</option>
        <option value="holiday" {{ 'selected' if work_type == 'holiday' }}>휴무</option>
        <option value="early" {{ 'selected' if work_type == 'early' }}>조퇴</option>
    </select>
    <button type="submit" class="btn btn-primary btn-sm">조회</button>
    <a href="/admin/attendance" class="btn btn-outline btn-sm">초기화</a>
</form>

<div class="table-wrap">
    <div class="table-header">
        <div class="table-title">근무 기록 ({{ stats.total }}건{% if pagination.pages > 1 %} / {{ pagination.page }}페이지{% endif %})</div>
        <div class="table-actions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <button type="button" class="btn btn-primary btn-sm" onclick="openAddModal()">+ 근무 추가</button>
            <button type="button" id="bulkDeleteBtn" class="btn btn-outline btn-sm" style="color:#dc3545;border-color:#dc3545;display:none;" onclick="bulkDelete()">
                선택 삭제 (<span id="bulkCount">0</span>건)
            </button>
            <button type="button" class="btn btn-outline btn-sm" style="color:#dc3545;border-color:#dc3545;" onclick="deleteFiltered()">
                조회결과 전체삭제
            </button>
            <a href="/admin/attendance/excel?start_date={{ start_date }}&end_date={{ end_date }}&emp_name={{ emp_name }}&work_type={{ work_type }}"
                class="btn btn-outline btn-sm">엑셀 다운로드</a>
        </div>
    </div>
    <div class="table-scroll">
        <table>
            <thead>
                <tr>
                    <th style="width:36px;text-align:center;"><input type="checkbox" id="checkAll" onchange="toggleAll(this)"></th>
                    <th>이름</th><th>고객사</th><th>부서/현장</th><th>날짜</th><th>생년월일</th>
                    <th>출근</th><th>퇴근</th><th>구분</th>
                    <th>총근무(h)</th><th>잔업(h)</th><th>심야(h)</th><th>특근(h)</th>
                    <th>출처</th>
                    <th style="text-align:center;">관리</th>
                </tr>
            </thead>
            <tbody>
                {% for r in records %}
                <tr id="row-{{ r.id }}">
                    <td style="text-align:center;"><input type="checkbox" class="row-check" value="{{ r.id }}" onchange="updateBulkBtn()"></td>
                    <td class="emp-name">{{ r.emp_name }}</td>
                    <td>{{ site_map.get(r.employee_id, '-') }}</td>
                    <td>{{ r.dept }}</td>
                    <td class="mono">{{ r.work_date.strftime('%Y-%m-%d') if r.work_date else '' }}</td>
                    <td class="mono">{{ r.birth_date }}</td>
                    <td class="mono">{{ r.clock_in or '' }}</td>
                    <td class="mono">{{ r.clock_out or '' }}</td>
                    <td>
                        {% if r.work_type == 'night' %}
                        <span class="badge badge-night">야간</span>
                        {% elif r.work_type == 'normal' %}
                        <span class="badge badge-day">주간</span>
                        {% elif r.work_type == 'annual' %}
                        <span class="badge badge-day">연차</span>
                        {% elif r.work_type == 'absent' %}
                        <span class="badge badge-day">결근</span>
                        {% elif r.work_type == 'holiday' %}
                        <span class="badge badge-day">휴무</span>
                        {% elif r.work_type == 'early' %}
                        <span class="badge badge-day">조퇴</span>
                        {% else %}
                        <span class="badge badge-day">{{ r.work_type }}</span>
                        {% endif %}
                    </td>
                    <td class="mono col-total">{{ r.total_work_hours }}</td>
                    <td class="mono col-ot">{{ r.overtime_hours }}</td>
                    <td class="mono col-night">{{ r.night_hours }}</td>
                    <td class="mono col-holiday">{{ r.holiday_work_hours or 0 }}</td>
                    <td>
                        {% if r.source == 'excel' %}
                        <span class="badge" style="background:#e0f2fe;color:#0369a1;font-size:11px;">엑셀</span>
                        {% elif r.source == 'admin' %}
                        <span class="badge" style="background:#fef3c7;color:#92400e;font-size:11px;">관리자</span>
                        {% else %}
                        <span class="badge" style="background:#e0e7ff;color:#4338ca;font-size:11px;">직원</span>
                        {% endif %}
                    </td>
                    <td style="text-align:center;">
                        <button type="button" class="btn btn-outline btn-sm"
                            onclick='openEditModal({{ r.to_dict()|tojson }})'
                            style="padding:4px 8px;">수정</button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="deleteRecord({{ r.id }})"
                            style="padding:4px 8px;color:#dc3545;border-color:#dc3545;">삭제</button>
                    </td>
                </tr>
                {% endfor %}
                {% if not records %}
                <tr>
                    <td colspan="14" style="text-align:center;padding:24px;color:var(--text2);">기록이 없습니다.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {% if pagination.pages > 1 %}
    <div style="display:flex;justify-content:center;align-items:center;gap:6px;padding:16px 0;">
        {% if pagination.has_prev %}
        <a href="?page={{ pagination.prev_num }}&start_date={{ start_date }}&end_date={{ end_date }}&emp_name={{ emp_name }}&work_type={{ work_type }}"
           class="btn btn-outline btn-sm">&laquo; 이전</a>
        {% endif %}

        {% for p in pagination.iter_pages(left_edge=1, left_current=2, right_current=2, right_edge=1) %}
            {% if p %}
                {% if p == pagination.page %}
                <span class="btn btn-primary btn-sm" style="pointer-events:none;">{{ p }}</span>
                {% else %}
                <a href="?page={{ p }}&start_date={{ start_date }}&end_date={{ end_date }}&emp_name={{ emp_name }}&work_type={{ work_type }}"
                   class="btn btn-outline btn-sm">{{ p }}</a>
                {% endif %}
            {% else %}
                <span style="color:var(--text2);">...</span>
            {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
        <a href="?page={{ pagination.next_num }}&start_date={{ start_date }}&end_date={{ end_date }}&emp_name={{ emp_name }}&work_type={{ work_type }}"
           class="btn btn-outline btn-sm">다음 &raquo;</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-card">
        <h3>근무 수정</h3>
        <form id="editForm" onsubmit="return submitEdit(event)">
            <input type="hidden" name="id">
            <div class="form-grid">
                <div>
                    <label class="form-label-block">이름</label>
                    <input type="text" name="emp_name" class="form-input" required style="width:100%">
                </div>
                <div>
                    <label class="form-label-block">생년월일</label>
                    <input type="text" name="birth_date" class="form-input" placeholder="YYMMDD" style="width:100%">
                </div>
            </div>
            <div class="form-group" style="margin-top:10px;">
                <label class="form-label-block">부서/현장</label>
                <input type="text" name="dept" class="form-input" style="width:100%">
            </div>
            <div class="form-group" style="margin-top:10px;">
                <label class="form-label-block">날짜</label>
                <input type="date" name="work_date" class="form-input" required style="width:100%">
            </div>
            <div class="form-grid" style="margin-top:10px;">
                <div>
                    <label class="form-label-block">출근</label>
                    <input type="time" name="clock_in" class="form-input" style="width:100%">
                </div>
                <div>
                    <label class="form-label-block">퇴근</label>
                    <input type="time" name="clock_out" class="form-input" style="width:100%">
                </div>
            </div>
            <div class="form-group" style="margin-top:10px;">
                <label class="form-label-block">근무 유형</label>
                <select name="work_type" class="form-input" style="width:100%">
                    <option value="normal">주간 근무</option>
                    <option value="night">야간 근무</option>
                    <option value="annual">연차</option>
                    <option value="absent">결근</option>
                    <option value="holiday">휴무</option>
                    <option value="early">조퇴</option>
                </select>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
                <button type="button" class="btn btn-outline" onclick="closeEditModal()">취소</button>
                <button type="submit" class="btn btn-primary">저장</button>
            </div>
        </form>
    </div>
</div>

<div id="addModal" class="modal-overlay">
    <div class="modal-card">
        <h3>근무 추가</h3>
        <form id="addForm" onsubmit="return submitAdd(event)">
            <div class="form-grid">
                <div>
                    <label class="form-label-block">이름 *</label>
                    <input type="text" name="emp_name" class="form-input" required style="width:100%" placeholder="직원 이름">
                </div>
                <div>
                    <label class="form-label-block">생년월일 *</label>
                    <input type="text" name="birth_date" class="form-input" required placeholder="YYMMDD" maxlength="6" style="width:100%">
                </div>
            </div>
            <div class="form-group" style="margin-top:10px;">
                <label class="form-label-block">부서/현장</label>
                <input type="text" name="dept" class="form-input" style="width:100%">
            </div>
            <div class="form-group" style="margin-top:10px;">
                <label class="form-label-block">날짜 *</label>
                <input type="date" name="work_date" class="form-input" required style="width:100%" value="{{ today.strftime('%Y-%m-%d') }}">
            </div>
            <div class="form-group" style="margin-top:10px;">
                <label class="form-label-block">근무 유형</label>
                <select name="work_type" class="form-input" style="width:100%" onchange="toggleAddTimeFields(this.value)">
                    <option value="normal">주간 근무</option>
                    <option value="night">야간 근무</option>
                    <option value="annual">연차</option>
                    <option value="absent">결근</option>
                    <option value="holiday">휴무</option>
                    <option value="early">조퇴</option>
                </select>
            </div>
            <div class="form-grid" style="margin-top:10px;" id="addTimeFields">
                <div>
                    <label class="form-label-block">출근</label>
                    <input type="time" name="clock_in" class="form-input" value="08:30" style="width:100%">
                </div>
                <div>
                    <label class="form-label-block">퇴근</label>
                    <input type="time" name="clock_out" class="form-input" value="19:00" style="width:100%">
                </div>
            </div>
            <div id="addConflictMsg" style="display:none;margin-top:12px;padding:10px 14px;border-radius:8px;background:#fef3c7;color:#92400e;font-size:13px;">
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
                <button type="button" class="btn btn-outline" onclick="closeAddModal()">취소</button>
                <button type="submit" class="btn btn-primary" id="addSubmitBtn">추가</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block page_js %}
const csrfToken = "{{ csrf_token() }}";

function openEditModal(data) {
    const form = document.getElementById("editForm");
    form.id.value = data.id || "";
    form.emp_name.value = data.emp_name || "";
    form.birth_date.value = data.birth_date || "";
    form.dept.value = data.dept || "";
    form.work_date.value = data.work_date || "";
    form.clock_in.value = data.clock_in || "";
    form.clock_out.value = data.clock_out || "";
    form.work_type.value = data.work_type || "normal";
    document.getElementById("editModal").style.display = "flex";
}

function closeEditModal() {
    document.getElementById("editModal").style.display = "none";
}

function submitEdit(e) {
    e.preventDefault();
    const form = document.getElementById("editForm");
    const id = form.id.value;
    const payload = {
        emp_name: form.emp_name.value,
        birth_date: form.birth_date.value,
        dept: form.dept.value,
        work_date: form.work_date.value,
        clock_in: form.clock_in.value,
        clock_out: form.clock_out.value,
        work_type: form.work_type.value,
    };
    fetch(`/api/attendance/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
        credentials: "same-origin",
        body: JSON.stringify(payload),
    })
    .then(r => r.json())
    .then(res => {
        if (!res.success) throw new Error(res.error || "수정 실패");
        location.reload();
    })
    .catch(err => showToast(err.message || "서버 연결 실패"));
    return false;
}

function toggleAll(master) {
    document.querySelectorAll('.row-check').forEach(cb => cb.checked = master.checked);
    updateBulkBtn();
}

function updateBulkBtn() {
    const checked = document.querySelectorAll('.row-check:checked');
    const btn = document.getElementById('bulkDeleteBtn');
    const cnt = document.getElementById('bulkCount');
    cnt.textContent = checked.length;
    btn.style.display = checked.length > 0 ? '' : 'none';
}

function bulkDelete() {
    const ids = [...document.querySelectorAll('.row-check:checked')].map(cb => parseInt(cb.value));
    if (!ids.length) return;
    showConfirm(`선택한 ${ids.length}건을 삭제하시겠습니까?`, () => {
        fetch('/api/attendance/bulk-delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            credentials: 'same-origin',
            body: JSON.stringify({ ids }),
        })
        .then(r => r.json())
        .then(res => {
            if (!res.success) throw new Error(res.error || '삭제 실패');
            showToast(`${res.deleted}건 삭제 완료`);
            setTimeout(() => location.reload(), 800);
        })
        .catch(err => showToast(err.message));
    });
}

function deleteFiltered() {
    const total = {{ stats.total }};
    if (!total) { showToast('삭제할 기록이 없습니다.'); return; }
    showConfirm(`현재 조회 조건의 ${total}건을 모두 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.`, () => {
        fetch('/api/attendance/bulk-delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            credentials: 'same-origin',
            body: JSON.stringify({
                filter: {
                    start_date: '{{ start_date }}',
                    end_date: '{{ end_date }}',
                    emp_name: '{{ emp_name }}',
                    work_type: '{{ work_type }}',
                }
            }),
        })
        .then(r => r.json())
        .then(res => {
            if (!res.success) throw new Error(res.error || '삭제 실패');
            showToast(`${res.deleted}건 삭제 완료`);
            setTimeout(() => location.reload(), 800);
        })
        .catch(err => showToast(err.message));
    });
}

function deleteRecord(id) {
    showConfirm("이 기록을 삭제하시겠습니까?", () => {
        fetch(`/api/attendance/${id}`, {
            method: "DELETE",
            headers: { "X-CSRFToken": csrfToken },
            credentials: "same-origin",
        })
        .then(r => r.json())
        .then(res => {
            if (!res.success) throw new Error(res.error || "삭제 실패");
            const row = document.getElementById(`row-${id}`);
            if (row) row.remove();
        })
        .catch(err => showToast(err.message || "서버 연결 실패"));
    });
}

/* ── 근무 추가 모달 ── */
let addPendingOverwrite = false;

function openAddModal() {
    const form = document.getElementById("addForm");
    form.reset();
    form.work_date.value = "{{ today.strftime('%Y-%m-%d') }}";
    form.clock_in.value = "08:30";
    form.clock_out.value = "19:00";
    document.getElementById("addTimeFields").style.display = "";
    document.getElementById("addConflictMsg").style.display = "none";
    document.getElementById("addSubmitBtn").textContent = "추가";
    addPendingOverwrite = false;
    document.getElementById("addModal").style.display = "flex";
}

function closeAddModal() {
    document.getElementById("addModal").style.display = "none";
    addPendingOverwrite = false;
}

function toggleAddTimeFields(workType) {
    const timeFields = document.getElementById("addTimeFields");
    const needsTime = ["normal", "night", "early"].includes(workType);
    timeFields.style.display = needsTime ? "" : "none";
}

function submitAdd(e) {
    e.preventDefault();
    const form = document.getElementById("addForm");
    const btn = document.getElementById("addSubmitBtn");
    const conflictEl = document.getElementById("addConflictMsg");

    const payload = {
        emp_name: form.emp_name.value.trim(),
        birth_date: form.birth_date.value.trim(),
        dept: form.dept.value.trim(),
        work_date: form.work_date.value,
        work_type: form.work_type.value,
        clock_in: form.clock_in.value,
        clock_out: form.clock_out.value,
    };

    if (addPendingOverwrite) {
        payload.overwrite = "true";
    }

    btn.disabled = true;
    btn.textContent = "처리중...";

    fetch("/api/attendance/admin", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
        credentials: "same-origin",
        body: JSON.stringify(payload),
    })
    .then(r => r.json().then(data => ({ status: r.status, data })))
    .then(({ status, data }) => {
        if (data.success) {
            showToast(data.overwritten ? "기존 기록을 덮어썼습니다." : "근무 기록이 추가되었습니다.");
            closeAddModal();
            setTimeout(() => location.reload(), 800);
            return;
        }
        if (status === 409 && data.conflict) {
            conflictEl.textContent = `이미 해당 날짜에 "${data.existing_source}" 기록이 있습니다. 덮어쓰시겠습니까?`;
            conflictEl.style.display = "block";
            btn.textContent = "덮어쓰기";
            btn.disabled = false;
            addPendingOverwrite = true;
            return;
        }
        throw new Error(data.error || "추가 실패");
    })
    .catch(err => {
        showToast(err.message || "서버 연결 실패");
        btn.disabled = false;
        btn.textContent = addPendingOverwrite ? "덮어쓰기" : "추가";
    });

    return false;
}

/* 모달 배경 클릭으로 닫기 */
document.getElementById("addModal").addEventListener("click", function(e) {
    if (e.target === this) closeAddModal();
});
document.getElementById("editModal").addEventListener("click", function(e) {
    if (e.target === this) closeEditModal();
});
{% endblock %}
