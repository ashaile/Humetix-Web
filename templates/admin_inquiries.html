{% extends "base_admin.html" %}

{% block admin_title %}HUMETIX - 문의 목록{% endblock %}
{% block page_title %}문의 목록 관리{% endblock %}
{% block page_desc %}접수된 문의를 검색하고 상태를 관리합니다.{% endblock %}

{% block page_css %}
.shell {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 16px;
    box-shadow: 0 14px 30px rgba(15, 40, 70, 0.08);
    padding: 24px;
}
.filter-card {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 16px;
}
.filter-grid {
    display: grid;
    grid-template-columns: minmax(280px, 1fr) 180px auto auto;
    gap: 10px;
    align-items: center;
}
.field {
    width: 100%;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--bg2);
    color: var(--text);
    padding: 10px 12px;
    font-size: 14px;
    font-family: inherit;
}
.summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    margin: 10px 0 12px;
    flex-wrap: wrap;
}
.summary strong {
    font-size: 32px;
    color: var(--accent);
    letter-spacing: -0.02em;
}
.table-box {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg2);
    overflow: hidden;
}
.table-scroll {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.table-scroll table {
    min-width: 1100px;
    width: 100%;
}
.table-scroll th,
.table-scroll td {
    white-space: nowrap;
    font-size: 13px;
}
.table-scroll td:nth-child(7) {
    white-space: normal;
    max-width: 260px;
    overflow: hidden;
    text-overflow: ellipsis;
}
.inline-input,
.inline-textarea {
    width: 100%;
    min-width: 100px;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 10px;
    background: var(--bg2);
    color: var(--text);
    font-size: 13px;
    font-family: inherit;
}
.inline-textarea {
    min-height: 66px;
    min-width: 140px;
    resize: vertical;
}
.helper {
    font-size: 13px;
    color: var(--text2);
}
.empty {
    text-align: center;
    padding: 56px 18px;
    color: var(--text2);
}
@media (max-width: 980px) {
    .shell { padding: 16px; }
    .filter-grid { grid-template-columns: 1fr; }
}
{% endblock %}

{% block content %}
{% set status_labels = {'new':'접수', 'in_progress':'진행중', 'done':'완료'} %}

<div class="shell">
    <div class="filter-card">
        <form method="get" action="{{ url_for('admin.inquiries') }}" class="filter-grid">
            <input type="text" name="q" class="field" placeholder="회사명/담당자/연락처/이메일 검색" value="{{ q }}">
            <select name="status" class="field">
                <option value="">전체 상태</option>
                {% for val in status_options %}
                <option value="{{ val }}" {% if status==val %}selected{% endif %}>{{ status_labels[val] }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary">조건 검색</button>
            <a href="{{ url_for('admin.inquiries') }}" class="btn btn-outline">초기화</a>
        </form>
    </div>

    <form method="post" action="{{ url_for('admin.delete_inquiries') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="summary">
            <div class="helper">총 <strong>{{ items|length }}</strong> 건 문의</div>
            <div style="display:flex; align-items:center; gap:10px;">
                <label class="helper">
                    <input type="checkbox" onclick="toggleAll(this)"> 전체 선택
                </label>
                <button type="submit" class="btn btn-danger btn-sm">선택 삭제</button>
            </div>
        </div>

        {% if not items %}
        <div class="table-box">
            <div class="empty">접수된 문의가 없거나 검색 결과가 없습니다.</div>
        </div>
        {% else %}
        <div class="table-box">
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th style="width:44px;">선택</th>
                            <th>접수일</th>
                            <th>회사명</th>
                            <th>담당자</th>
                            <th>연락처</th>
                            <th>이메일</th>
                            <th>문의 내용</th>
                            <th>상태</th>
                            <th>담당자(내부)</th>
                            <th>관리자 메모</th>
                            <th style="width:84px;">저장</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr>
                            <td><input type="checkbox" name="selected_ids" value="{{ item.id }}"></td>
                            <td class="mono">{{ item.created_at.strftime('%Y-%m-%d %H:%M') if item.created_at else '' }}</td>
                            <td>{{ item.company }}</td>
                            <td>{{ item.name }}</td>
                            <td>{{ item.phone }}</td>
                            <td>{{ item.email or '-' }}</td>
                            <td>{{ item.message or '-' }}</td>
                            <td>
                                <select id="status-{{ item.id }}" class="inline-input">
                                    {% for val in status_options %}
                                    <option value="{{ val }}" {% if item.status==val %}selected{% endif %}>{{ status_labels[val] }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="text" id="assignee-{{ item.id }}" class="inline-input"
                                    value="{{ item.assignee or '' }}" placeholder="담당자">
                            </td>
                            <td>
                                <textarea id="memo-{{ item.id }}" class="inline-textarea"
                                    placeholder="메모">{{ item.admin_memo or '' }}</textarea>
                            </td>
                            <td>
                                <button type="button" class="btn btn-primary btn-sm"
                                    onclick="saveInquiry({{ item.id }})">상태 저장</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </form>
</div>
{% endblock %}

{% block page_js %}
const csrfToken = '{{ csrf_token() }}';

function toggleAll(source) {
    document.getElementsByName("selected_ids").forEach(cb => {
        cb.checked = source.checked;
    });
}

async function saveInquiry(id) {
    const status = document.getElementById(`status-${id}`).value;
    const assignee = document.getElementById(`assignee-${id}`).value;
    const memo = document.getElementById(`memo-${id}`).value;

    const formData = new FormData();
    formData.append("status", status);
    formData.append("assignee", assignee);
    formData.append("admin_memo", memo);
    formData.append("csrf_token", csrfToken);

    const res = await fetch(`/inquiries/update/${id}`, {
        method: "POST",
        body: formData
    });
    if (res.ok) {
        showToast("저장되었습니다.");
    } else {
        showToast("저장에 실패했습니다.");
    }
}
{% endblock %}
