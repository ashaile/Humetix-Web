{% extends "base_admin.html" %}

{% block admin_title %}HUMETIX - 가불 관리{% endblock %}
{% block page_title %}가불 관리 (관리자){% endblock %}
{% block page_desc %}직원 가불 신청을 승인하거나 반려합니다.{% endblock %}

{% block page_css %}
.action-btns {
    display: flex;
    gap: 4px;
}
{% endblock %}

{% block content %}
<form method="get" action="/admin/advance" class="filter-bar">
    <input type="month" name="month" class="form-input" value="{{ month }}" placeholder="월">
    <select name="status" class="form-select">
        <option value="">전체 상태</option>
        <option value="pending" {{ 'selected' if filter_status=='pending' }}>대기</option>
        <option value="approved" {{ 'selected' if filter_status=='approved' }}>승인</option>
        <option value="rejected" {{ 'selected' if filter_status=='rejected' }}>반려</option>
        <option value="paid" {{ 'selected' if filter_status=='paid' }}>지급완료</option>
        <option value="cancelled" {{ 'selected' if filter_status=='cancelled' }}>취소</option>
    </select>
    <button type="submit" class="btn btn-primary btn-sm">조회</button>
</form>

<div class="table-wrap">
    <div class="table-header">
        <div class="table-title">가불 신청 목록 ({{ items|length }}건)</div>
    </div>
    <div class="table-scroll">
        <table>
            <thead>
                <tr>
                    <th>신청일</th>
                    <th>생년월일</th>
                    <th>이름</th>
                    <th>부서</th>
                    <th>근무형태</th>
                    <th>신청월</th>
                    <th>금액</th>
                    <th>상태</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td>{{ item.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>{{ item.birth_date }}</td>
                    <td>{{ item.emp_name }}</td>
                    <td>{{ item.dept }}</td>
                    {% if item.status == 'pending' %}
                    <div class="action-btns">
                        <button class="btn btn-success btn-sm"
                            onclick="processAdvance({{ item.id }}, 'approve')">승인</button>
                        <button class="btn btn-danger btn-sm"
                            onclick="processAdvance({{ item.id }}, 'reject')">반려</button>
                    </div>
                    {% else %}
                    <span style="color:var(--text2);font-size:12px;">처리완료</span>
                    {% endif %}
                    </td>
                </tr>
                {% endfor %}
                {% if not items %}
                <tr>
                    <td colspan="11" style="text-align:center;padding:24px;color:var(--text2);">가불 신청이 없습니다.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block page_js %}
const csrfToken = '{{ csrf_token() }}';

function processAdvance(id, action) {
    const comment = action === 'reject' ? prompt('반려 사유를 입력하세요:') : '';
    if (action === 'reject' && comment === null) return;

    const fd = new FormData();
    fd.append('comment', comment || '');
    fd.append('csrf_token', csrfToken);

    fetch(`/admin/advance/${id}/${action}`, { method: 'POST', body: fd })
        .then(r => r.json())
        .then(res => {
            if (res.success) {
                showToast(action === 'approve' ? '승인 완료' : '반려 완료');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('오류: ' + res.error);
            }
        })
        .catch(() => showToast('서버 연결 실패'));
}
{% endblock %}
