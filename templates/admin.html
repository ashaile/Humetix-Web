<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #f4f7f9;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #003057;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 160px;
            /* ë²„íŠ¼ ë„ˆë¹„ ê³ ì • */
            box-sizing: border-box;
            /* íŒ¨ë”© í¬í•¨ ë„ˆë¹„ ê³„ì‚° */
            height: 40px;
            /* ë†’ì´ë„ ê³ ì •í•˜ì—¬ í†µì¼ê° ë¶€ì—¬ */
            vertical-align: middle;
        }

        .btn-excel {
            background: #28a745;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-logout {
            background: #6c757d;
            color: white;
        }

        .card {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            background: #fff;
            position: relative;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 10px;
            margin: -20px -20px 15px -20px;
            border-bottom: 1px solid #ddd;
            border-radius: 10px 10px 0 0;
        }

        .info-group {
            margin-bottom: 10px;
        }

        .label {
            font-weight: bold;
            color: #555;
            display: inline-block;
            width: 80px;
        }

        .photo-box {
            position: absolute;
            top: 60px;
            right: 20px;
            width: 100px;
            height: 130px;
            border: 1px solid #ddd;
        }

        .photo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .career-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .career-table th,
        .career-table td {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: center;
        }

        .career-table th {
            background: #f1f3f5;
        }

        .checkbox-wrapper {
            margin-right: 10px;
            transform: scale(1.5);
        }

        .search-container {
            background: #fff;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            flex-grow: 1;
        }

        .search-select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .btn-search {
            background: #003057;
            color: white;
            width: 80px;
            height: 35px;
        }

        .memo-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #ddd;
        }

        .memo-textarea {
            width: 100%;
            height: 60px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: none;
            box-sizing: border-box;
            background: #fffef0;
        }

        .btn-save-memo {
            margin-top: 5px;
            background: #6c757d;
            color: white;
            font-size: 0.8rem;
            width: 100px;
            height: 30px;
        }
    </style>
    <script>
        function toggleAll(source) {
            var checkboxes = document.getElementsByName('selected_ids');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = source.checked;
            }
        }

        async function saveMemo(appId) {
            const memoText = document.getElementById(`memo-${appId}`).value;
            const btn = event.target;
            const originalText = btn.innerText;

            btn.innerText = "ì €ì¥ ì¤‘...";
            btn.disabled = true;

            const formData = new FormData();
            formData.append('memo', memoText);
            formData.append('csrf_token', '{{ csrf_token() }}');

            try {
                const response = await fetch(`/update_memo/${appId}`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    btn.innerText = "ì €ì¥ë¨!";
                    btn.style.background = "#28a745";
                    setTimeout(() => {
                        btn.innerText = originalText;
                        btn.style.background = "#6c757d";
                        btn.disabled = false;
                    }, 2000);
                } else {
                    alert("ì €ì¥ ì‹¤íŒ¨: " + result.message);
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            } catch (error) {
                console.error("Error saving memo:", error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }
    </script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h2 style="color:#003057; margin:0;">ê´€ë¦¬ì í˜ì´ì§€</h2>
            <div>
                <a href="/download_excel" class="btn btn-excel">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a>
                <button onclick="document.getElementById('delete-form').submit();" <div
                    class="row align-items-center mb-4">
                    <div class="col-md-6">
                        <h2 class="fw-bold text-primary"><i class="bi bi-people-fill me-2"></i>ì§€ì›ì ê´€ë¦¬ (ì´ {{ data|length
                            }}ëª…)</h2>
                    </div>
                    <div class="col-md-6 text-end">
                        <!-- ê²€ìƒ‰ í¼ -->
                        <form action="{{ url_for('admin.master_view') }}" method="get"
                            class="d-flex justify-content-end gap-2">
                            <select name="type" class="form-select w-auto">
                                <option value="name" {% if search_type=='name' %}selected{% endif %}>ì´ë¦„</option>
                                <option value="phone" {% if search_type=='phone' %}selected{% endif %}>ì—°ë½ì²˜</option>
                            </select>
                            <input type="text" name="q" class="form-control w-auto" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥"
                                value="{{ search_query }}">
                            <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
                            <button type="button" class="btn btn-secondary" data-bs-toggle="collapse"
                                data-bs-target="#detailedFilters">ìƒì„¸ê²€ìƒ‰</button>
                            <a href="{{ url_for('admin.master_view') }}" class="btn btn-outline-secondary">ì´ˆê¸°í™”</a>
                        </form>
                    </div>
            </div>

            <!-- ìƒì„¸ ê²€ìƒ‰ í•„í„° (ì ‘ì´ì‹) -->
            <div class="collapse mb-4" id="detailedFilters">
                <div class="card card-body bg-light">
                    <form action="{{ url_for('admin.master_view') }}" method="get">
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label class="form-label fw-bold">ì„±ë³„</label>
                                <select name="gender" class="form-select">
                                    <option value="">ì „ì²´</option>
                                    <option value="ë‚¨" {% if filters and filters.gender=='ë‚¨' %}selected{% endif %}>ë‚¨ì
                                    </option>
                                    <option value="ì—¬" {% if filters and filters.gender=='ì—¬' %}selected{% endif %}>ì—¬ì
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">êµëŒ€ê·¼ë¬´</label>
                                <select name="shift" class="form-select">
                                    <option value="">ì „ì²´</option>
                                    <option value="ê°€ëŠ¥" {% if filters and filters.shift=='ê°€ëŠ¥' %}selected{% endif %}>ê°€ëŠ¥
                                    </option>
                                    <option value="ë¶ˆê°€ëŠ¥" {% if filters and filters.shift=='ë¶ˆê°€ëŠ¥' %}selected{% endif %}>ë¶ˆê°€ëŠ¥
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">ì¢Œì‹ê·¼ë¬´</label>
                                <select name="posture" class="form-select">
                                    <option value="">ì „ì²´</option>
                                    <option value="ê°€ëŠ¥" {% if filters and filters.posture=='ê°€ëŠ¥' %}selected{% endif %}>ê°€ëŠ¥
                                    </option>
                                    <option value="ë¶ˆê°€ëŠ¥" {% if filters and filters.posture=='ë¶ˆê°€ëŠ¥' %}selected{% endif %}>
                                        ë¶ˆê°€ëŠ¥</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">ì”ì—…</label>
                                <select name="overtime" class="form-select">
                                    <option value="">ì „ì²´</option>
                                    <option value="ê°€ëŠ¥" {% if filters and filters.overtime=='ê°€ëŠ¥' %}selected{% endif %}>ê°€ëŠ¥
                                    </option>
                                    <option value="ë¶ˆê°€ëŠ¥" {% if filters and filters.overtime=='ë¶ˆê°€ëŠ¥' %}selected{% endif %}>
                                        ë¶ˆê°€ëŠ¥</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">íŠ¹ê·¼</label>
                                <select name="holiday" class="form-select">
                                    <option value="">ì „ì²´</option>
                                    <option value="ê°€ëŠ¥" {% if filters and filters.holiday=='ê°€ëŠ¥' %}selected{% endif %}>ê°€ëŠ¥
                                    </option>
                                    <option value="ë¶ˆê°€ëŠ¥" {% if filters and filters.holiday=='ë¶ˆê°€ëŠ¥' %}selected{% endif %}>
                                        ë¶ˆê°€ëŠ¥</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">ê²€ìƒ‰ ì‹¤í–‰</label>
                                <button type="submit" class="btn btn-primary w-100">í•„í„° ì ìš©</button>
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-3">
                                <label class="form-label fw-bold">ì ‘ìˆ˜ì¼ ê¸°ê°„ ì„¤ì •</label>
                                <div class="input-group">
                                    <input type="date" name="start_date" class="form-control"
                                        value="{{ start_date if start_date else '' }}">
                                    <span class="input-group-text">~</span>
                                    <input type="date" name="end_date" class="form-control"
                                        value="{{ end_date if end_date else '' }}">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">ê°€ë¶ˆ í¬ë§</label>
                                <select name="advance_pay" class="form-select">
                                    <option value="">ì „ì²´</option>
                                    <option value="í¬ë§í•¨" {% if filters and filters.advance_pay=='í¬ë§í•¨' %}selected{% endif
                                        %}>í¬ë§í•¨</option>
                                    <option value="í¬ë§ì•ˆí•¨" {% if filters and filters.advance_pay=='í¬ë§ì•ˆí•¨' %}selected{%
                                        endif %}>í¬ë§ì•ˆí•¨</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">ê¸‰ì—¬ í˜•íƒœ</label>
                                <select name="insurance_type" class="form-select">
                                    <option value="">ì „ì²´</option>
                                    <option value="4ëŒ€ë³´í—˜" {% if filters and filters.insurance_type=='4ëŒ€ë³´í—˜' %}selected{%
                                        endif %}>4ëŒ€ë³´í—˜</option>
                                    <option value="3.3%" {% if filters and filters.insurance_type=='3.3%' %}selected{%
                                        endif %}>3.3%</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
            </div>


            <form method="post" action="{{ url_for('admin.delete_selected') }}" id="deleteForm">

                {% for entry in data %}
                <div class="card">
                    <div class="card-header">
                        <div>
                            <input type="checkbox" name="selected_ids" value="{{ entry.id }}" class="checkbox-wrapper">
                            <span style="font-weight:bold; font-size:1.1rem;">{{ entry.info.name }} ({{ entry.info.birth
                                }})</span>
                            {% if entry.info.gender %}
                            <span class="badge bg-secondary ms-2">{{ entry.info.gender }}</span>
                            {% endif %}
                            <span style="color:#888; font-size:0.9rem; margin-left:10px;">ì ‘ìˆ˜: {{ entry.timestamp
                                }}</span>
                        </div>nput type="checkbox" onclick="toggleAll(this)"> ì „ì²´ ì„ íƒ
                    </div>

                    {% if not data %}
                    <p style="text-align:center; padding:50px;">ì ‘ìˆ˜ëœ ì§€ì›ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    {% endif %}

                    {% for entry in data %}
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <input type="checkbox" name="selected_ids" value="{{ entry.id }}"
                                    class="checkbox-wrapper">
                                <span style="font-weight:bold; font-size:1.1rem;">{{ entry.info.name }} ({{
                                    entry.info.birth
                                    }})</span>
                                <span style="color:#888; font-size:0.9rem; margin-left:10px;">ì ‘ìˆ˜: {{ entry.timestamp
                                    }}</span>
                            </div>
                        </div>

                        {% if entry.photo %}
                        <div class="photo-box">
                            <a href="/view_photo/{{ entry.photo }}" target="_blank">
                                <img src="/view_photo/{{ entry.photo }}">
                            </a>
                        </div>
                        {% else %}
                        <div class="photo-box"
                            style="display:flex; align-items:center; justify-content:center; background:#eee; color:#aaa; font-size:0.8rem;">
                            ì‚¬ì§„ì—†ìŒ
                        </div>
                        {% endif %}

                        <div style="width: 75%;">
                            <div class="info-group"><span class="label">ì—°ë½ì²˜</span> {{ entry.info.phone }}</div>
                            <div class="info-group"><span class="label">ì£¼ì†Œ</span> {{ entry.info.address }}</div>
                            <div class="info-group"><span class="label">ì‹ ì²´</span> {{ entry.body.height }}cm / {{
                                entry.body.weight }}kg / {{ entry.body.vision }} / {{ entry.body.shoes }} / {{
                                entry.body.tshirt
                                }}</div>
                            <div class="info-group"><span class="label">ê·¼ë¬´ì¡°ê±´</span> {{ entry.work_condition.shift }} /
                                {{
                                entry.work_condition.posture }} / ì”ì—…:{{ entry.work_condition.overtime }} / íŠ¹ê·¼:{{
                                entry.work_condition.holiday }}</div>
                            <div class="info-group"><span class="label">í¬ë§ì¼ì •</span> ë©´ì ‘ê°€ëŠ¥: <span
                                    style="color:#0056b3; font-weight:bold;">{{ entry.work_condition.interview_date
                                    }}</span> /
                                ì…ì‚¬í¬ë§: <span style="color:#0056b3; font-weight:bold;">{{ entry.work_condition.start_date
                                    }}</span></div>
                            <div class="info-group"><span class="label">ê¸°íƒ€</span> ê°€ë¶ˆ: <span style="font-weight:bold;">{{
                                    entry.extra.advance_pay if entry.extra and entry.extra.advance_pay else 'ë¹„í¬ë§'
                                    }}</span> /
                                ê¸‰ì—¬í˜•íƒœ: <span style="font-weight:bold;">{{ entry.extra.insurance_type if entry.extra and
                                    entry.extra.insurance_type else '4ëŒ€ë³´í—˜' }}</span></div>

                            <table class="career-table">
                                <tr>
                                    <th width="25%">íšŒì‚¬ëª…</th>
                                    <th width="30%">ê¸°ê°„</th>
                                    <th width="20%">ë‹´ë‹¹ì—…ë¬´</th>
                                    <th width="25%">í‡´ì‚¬ì‚¬ìœ </th>
                                </tr>
                                {% if entry.career %}
                                {% for car in entry.career %}
                                <tr>
                                    <td>{{ car.company }}</td>
                                    <td>{{ car.start }}~{{ car.end }}</td>
                                    <td>{{ car.role }}</td>
                                    <td>{{ car.reason }}</td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="4">ê²½ë ¥ ì‚¬í•­ ì—†ìŒ</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>

                        <div class="memo-section">
                            <div style="font-weight:bold; margin-bottom:5px; font-size:0.9rem;">ê´€ë¦¬ì ë©”ëª¨</div>
                            <textarea id="memo-{{ entry.id }}" class="memo-textarea"
                                placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">{{ entry.memo }}</textarea>
                            <button type="button" class="btn btn-save-memo" onclick="saveMemo('{{ entry.id }}')">ë©”ëª¨
                                ì €ì¥</button>
                        </div>
                    </div>
                    {% endfor %}

            </form>
        </div>
</body>

</html>