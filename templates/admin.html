{% extends "base_admin.html" %}

{% block admin_title %}HUMETIX - 관리자 페이지{% endblock %}
{% block page_title %}관리자 페이지{% endblock %}
{% block page_desc %}지원자 현황을 조회하고 관리합니다.{% endblock %}

{% block page_css %}
/* ── Filter section ── */
.filter-section {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 18px;
    margin-bottom: 22px;
}
.search-row {
    display: grid;
    grid-template-columns: minmax(280px, 1fr);
    gap: 12px;
    align-items: end;
    margin-bottom: 14px;
}
.search-field { width: 100%; }
.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
}
.filter-actions {
    margin-top: 18px;
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
}
.filter-group-title {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--text2);
    margin-bottom: 8px;
    display: block;
}

/* ── Results bar ── */
.results-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
    flex-wrap: wrap;
}
.total-count {
    font-size: 1.2rem;
    margin: 0;
    font-weight: 700;
}
.empty-state {
    text-align: center;
    padding: 64px 20px;
    color: var(--text2);
    border: 1px dashed var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg3);
}

/* ── Form controls (local overrides) ── */
.form-control {
    height: 38px;
    padding: 6px 12px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.95rem;
    font-family: inherit;
    background: var(--bg);
    color: var(--text);
}
.form-control:focus {
    border-color: var(--accent);
    outline: none;
    box-shadow: 0 0 0 3px rgba(232,93,38,.1);
}
.security-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
    align-items: end;
}
.security-help {
    margin-top: 10px;
    color: var(--text2);
    font-size: 0.85rem;
}

/* ── Card / applicant ── */
.card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    margin-bottom: 15px;
    box-shadow: var(--shadow);
    position: relative;
}
.card-header {
    background: var(--bg3);
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    border-radius: 8px 8px 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.card-body {
    padding: 20px;
    display: flex;
    gap: 20px;
}

.applicant-photo {
    width: 120px;
    height: 160px;
    background: var(--bg3);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text2);
    font-size: 0.8rem;
    flex-shrink: 0;
}
.applicant-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.applicant-info { flex: 1; }
.info-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}
.info-columns .left-group  { max-width: 420px; }
.info-columns .right-group { max-width: 420px; }
.info-columns .right-group .info-block-title:first-of-type { margin-top: 0; }

.info-block-title {
    margin: 6px 0 10px 0;
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--text2);
    letter-spacing: 0.2px;
    text-transform: uppercase;
}
.info-grid {
    display: grid;
    grid-template-columns: 90px 1fr;
    row-gap: 8px;
    column-gap: 10px;
}
.info-label {
    font-weight: 600;
    color: var(--text2);
}
.info-value {
    color: var(--text);
    word-break: break-word;
}
.info-value .info-multiline {
    display: block;
    line-height: 1.6;
}
.info-divider {
    height: 1px;
    background: var(--border);
    margin: 12px 0;
}
.info-row {
    margin-bottom: 8px;
    font-size: 0.95rem;
    line-height: 1.5;
}
.info-group-title {
    margin: 8px 0 6px 0;
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--text2);
    letter-spacing: 0.2px;
    text-transform: uppercase;
}

.label-badge {
    display: inline-block;
    width: 70px;
    font-weight: 600;
    color: var(--text2);
}
.data-val { color: var(--text); }
.highlight {
    color: var(--accent);
    font-weight: 600;
}

/* ── Career table ── */
.career-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 0.9rem;
}
.career-table th {
    background: var(--bg3);
    color: var(--text2);
    padding: 8px;
    border: 1px solid var(--border);
}
.career-table td {
    padding: 8px;
    border: 1px solid var(--border);
    text-align: center;
}

/* ── Memo box ── */
.memo-box {
    margin-top: 15px;
    padding: 15px;
    background: #fffcf0;
    border: 1px dashed #e0dcbf;
    border-radius: 6px;
}
.memo-textarea {
    width: 100%;
    height: 50px;
    border: 1px solid #e0dcbf;
    background: transparent;
    resize: none;
    padding: 5px;
    font-size: 0.9rem;
    font-family: inherit;
    color: var(--text);
}

/* ── Pagination ── */
.pagination {
    display: flex;
    justify-content: center;
    gap: 5px;
    margin-top: 30px;
}
.page-link {
    display: inline-flex;
    width: 36px;
    height: 36px;
    justify-content: center;
    align-items: center;
    border: 1px solid var(--border);
    color: var(--accent);
    background: var(--bg2);
    border-radius: 4px;
    text-decoration: none;
    font-weight: 600;
}
.page-link.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
}
.page-link:hover:not(.active) {
    background: var(--bg3);
}

/* ── Status badge variants ── */
.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
}
.status-badge.new       { background: #e0e7ff; color: #4338ca; }
.status-badge.review    { background: #fef3c7; color: #b45309; }
.status-badge.interview { background: #dbeafe; color: #1d4ed8; }
.status-badge.offer     { background: #f3e8ff; color: #7c3aed; }
.status-badge.hired     { background: #dcfce7; color: #16a34a; }
.status-badge.rejected  { background: #fee2e2; color: var(--danger); }

/* ── Responsive ── */
@media (max-width: 1100px) {
    .info-columns .left-group,
    .info-columns .right-group {
        max-width: none;
    }
}
@media (max-width: 900px) {
    .info-columns {
        grid-template-columns: 1fr;
    }
}
@media (max-width: 820px) {
    .search-row {
        grid-template-columns: 1fr;
    }
}
{% endblock %}

{% block content %}
{% set status_labels = {'new':'신규','review':'검토','interview':'면접','offer':'오퍼','hired':'합격','rejected':'불합격'} %}

<div class="filter-section">
    <div class="filter-group-title" style="margin-bottom: 12px;">관리자 비밀번호 변경</div>
    <form id="passwordChangeForm" onsubmit="event.preventDefault(); changeAdminPassword();">
        <div class="security-grid">
            <div>
                <label class="filter-group-title">현재 비밀번호</label>
                <input type="password" id="currentPassword" class="form-control" required>
            </div>
            <div>
                <label class="filter-group-title">새 비밀번호</label>
                <input type="password" id="newPassword" class="form-control" minlength="4" required>
            </div>
            <div>
                <label class="filter-group-title">새 비밀번호 확인</label>
                <input type="password" id="confirmPassword" class="form-control" minlength="4" required>
            </div>
            <div>
                <button type="submit" class="btn btn-primary" id="changePasswordBtn">비밀번호 변경</button>
            </div>
        </div>
    </form>
    <p class="security-help">저장 즉시 로그인 비밀번호에 반영됩니다.</p>
</div>

<div class="filter-section">
    <form id="searchForm" action="{{ url_for('admin.master_view') }}" method="get">
        <div class="search-row">
            <div class="search-field">
                <input type="text" name="q" class="form-control" placeholder="이름 또는 연락처 검색"
                    value="{{ search_query }}">
                <input type="hidden" name="type" value="name">
            </div>
        </div>

        <div class="filters-grid">
            <div>
                <label class="filter-group-title">성별</label>
                <select name="gender" class="form-select">
                    <option value="">전체</option>
                    <option value="남" {% if filters.gender=='남' %}selected{% endif %}>남자</option>
                    <option value="여" {% if filters.gender=='여' %}selected{% endif %}>여자</option>
                </select>
            </div>
            <div>
                <label class="filter-group-title">근무형태</label>
                <select name="shift" class="form-select">
                    <option value="">전체</option>
                    <option value="주간" {% if filters.shift=='주간' %}selected{% endif %}>주간</option>
                    <option value="2교대" {% if filters.shift=='2교대' %}selected{% endif %}>2교대</option>
                </select>
            </div>
            <div>
                <label class="filter-group-title">근무방식</label>
                <select name="posture" class="form-select">
                    <option value="">전체</option>
                    <option value="무관" {% if filters.posture=='무관' %}selected{% endif %}>무관</option>
                    <option value="좌식" {% if filters.posture=='좌식' %}selected{% endif %}>좌식</option>
                    <option value="입식" {% if filters.posture=='입식' %}selected{% endif %}>입식</option>
                </select>
            </div>
            <div>
                <label class="filter-group-title">잔업</label>
                <select name="overtime" class="form-select">
                    <option value="">전체</option>
                    <option value="가능" {% if filters.overtime=='가능' %}selected{% endif %}>가능</option>
                    <option value="불가능" {% if filters.overtime=='불가능' %}selected{% endif %}>불가능</option>
                </select>
            </div>
            <div>
                <label class="filter-group-title">특근</label>
                <select name="holiday" class="form-select">
                    <option value="">전체</option>
                    <option value="가능" {% if filters.holiday=='가능' %}selected{% endif %}>가능</option>
                    <option value="불가능" {% if filters.holiday=='불가능' %}selected{% endif %}>불가능</option>
                </select>
            </div>
            <div>
                <label class="filter-group-title">상태</label>
                <select name="status" class="form-select">
                    <option value="">전체</option>
                    {% for val in status_options %}
                    <option value="{{ val }}" {% if filters.status==val %}selected{% endif %}>{{
                        status_labels[val] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="filter-group-title">가불 희망</label>
                <select name="advance_pay" class="form-select">
                    <option value="">전체</option>
                    <option value="희망" {% if filters.advance_pay=='희망' %}selected{% endif %}>희망</option>
                    <option value="비희망" {% if filters.advance_pay=='비희망' %}selected{% endif %}>비희망</option>
                </select>
            </div>
            <div>
                <label class="filter-group-title">급여 형태</label>
                <select name="insurance_type" class="form-select">
                    <option value="">전체</option>
                    <option value="3.3%" {% if filters.insurance_type=='3.3%' %}selected{% endif %}>3.3%
                    </option>
                    <option value="4대보험" {% if filters.insurance_type=='4대보험' %}selected{% endif %}>4대보험
                    </option>
                </select>
            </div>
            <div>
                <label class="filter-group-title">접수기간(시작)</label>
                <input type="date" name="start_date" class="form-control" value="{{ start_date or '' }}">
            </div>
            <div>
                <label class="filter-group-title">접수기간(종료)</label>
                <input type="date" name="end_date" class="form-control" value="{{ end_date or '' }}">
            </div>
        </div>

        <div class="filter-actions">
            <button type="submit" class="btn btn-primary" style="width: 200px;">조건 검색</button>
            <a href="{{ url_for('admin.master_view') }}" class="btn btn-outline">초기화</a>
        </div>
    </form>
</div>

<div class="results-bar">
    <h3 class="total-count">
        총 <span style="color: var(--accent);">{{ pagination.total }}</span>명 지원
    </h3>
    <div style="display: flex; gap: 8px; align-items: center;">
        <a href="/download_excel{{ '?' + query_string if query_string else '' }}" class="btn btn-success btn-sm">엑셀 다운로드</a>
        <button onclick="if(confirm('선택한 항목을 삭제하시겠습니까?')) document.getElementById('deleteForm').submit();"
            class="btn btn-danger btn-sm">선택 삭제</button>
    </div>
</div>

<form method="post" action="{{ url_for('admin.delete_selected') }}" id="deleteForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    {% if not data %}
    <div class="empty-state">
        접수된 지원서가 없거나 검색 결과가 없습니다.
    </div>
    {% endif %}

    {% for entry in data %}
    <div class="card">
        <div class="card-header">
            <div style="display: flex; align-items: center;">
                <input type="checkbox" name="selected_ids" value="{{ entry.id }}"
                    style="transform: scale(1.2); margin-right: 12px;">
                <span style="font-weight: 700; font-size: 1.1rem; margin-right: 8px;">{{ entry.info.name
                    }}</span>

                {% if entry.info.gender == '남' %}
                <span class="badge" style="background-color: #007bff;">남</span>
                {% elif entry.info.gender == '여' %}
                <span class="badge" style="background-color: #dc3545;">여</span>
                {% endif %}

                <span style="color: var(--text2); font-size: 0.85rem; margin-left: auto;">
                    접수일: {{ entry.timestamp }}
                </span>
            </div>
        </div>

        <div class="card-body">
            {% if entry.photo %}
            <div class="applicant-photo">
                <a href="/view_photo/{{ entry.photo }}" target="_blank">
                    <img src="/view_photo/{{ entry.photo }}">
                </a>
            </div>
            {% else %}
            <div class="applicant-photo">사진없음</div>
            {% endif %}

            <div class="applicant-info">
                <div class="info-columns">
                    <div class="left-group">
                        <div class="info-block-title">기본정보</div>
                        <div class="info-grid">
                            <div class="info-label">생년월일</div>
                            <div class="info-value">{{ entry.info.birth }}</div>
                            <div class="info-label">연락처</div>
                            <div class="info-value">{{ entry.info.phone }}</div>
                            <div class="info-label">이메일</div>
                            <div class="info-value">{{ entry.info.email or '-' }}</div>
                            <div class="info-label">주소</div>
                            <div class="info-value">{{ entry.info.address }}</div>
                            <div class="info-label">사진</div>
                            <div class="info-value">{{ "있음" if entry.photo else "없음" }}</div>
                        </div>
                        <div class="info-divider"></div>
                        <div class="info-block-title">신체/사이즈</div>
                        <div class="info-grid">
                            <div class="info-label">신체</div>
                            <div class="info-value">{{ entry.body.height or '-' }}cm / {{ entry.body.weight or
                                '-' }}kg
                            </div>
                            <div class="info-label">시력</div>
                            <div class="info-value">{{ entry.body.vision or '-' }}</div>
                            <div class="info-label">사이즈</div>
                            <div class="info-value">신발: {{ entry.body.shoes or '-' }} / 티셔츠: {{
                                entry.body.tshirt or '-'
                                }}</div>
                        </div>
                    </div>
                    <div class="right-group">
                        <div class="info-block-title">근무/희망</div>
                        <div class="info-grid">
                            <div class="info-label">근무</div>
                            <div class="info-value">
                                <span class="info-multiline">형태: {{ entry.work_condition.shift or '-' }}</span>
                                <span class="info-multiline">방식: {{ entry.work_condition.posture or '-'
                                    }}</span>
                                <span class="info-multiline">잔업: {{ entry.work_condition.overtime or '-'
                                    }}</span>
                                <span class="info-multiline">특근: {{ entry.work_condition.holiday or '-'
                                    }}</span>
                            </div>
                            <div class="info-label">희망</div>
                            <div class="info-value">
                                <span class="info-multiline">가불: {{ entry.extra.advance_pay or '-' }}</span>
                                <span class="info-multiline">급여: {{ entry.extra.insurance_type or '-' }}</span>
                            </div>
                        </div>
                        <div class="info-divider"></div>
                        <div class="info-block-title">일정/상태</div>
                        <div class="info-grid">
                            <div class="info-label">일정</div>
                            <div class="info-value">
                                <span class="highlight">면접: {{ entry.work_condition.interview_date or '미정'
                                    }}</span>
                                /
                                <span class="highlight">입사: {{ entry.work_condition.start_date or '미정' }}</span>
                            </div>
                            <div class="info-label">상태</div>
                            <div class="info-value" style="display:flex; align-items:center; gap:8px;">
                                <select id="status-{{ entry.id }}" class="form-select"
                                    style="width: 160px; height: 32px;">
                                    {% for val in status_options %}
                                    <option value="{{ val }}" {% if entry.status==val %}selected{% endif %}>{{
                                        status_labels[val] }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" id="btn-status-{{ entry.id }}" class="btn btn-sm"
                                    style="height: 32px; font-size: 0.8rem; padding: 0 10px; background: var(--text2); color: #fff;"
                                    onclick="saveStatus('{{ entry.id }}')">저장</button>
                            </div>
                        </div>
                    </div>
                </div>

                <table class="career-table">
                    <thead>
                        <tr>
                            <th style="width: 20%;">회사명</th>
                            <th style="width: 25%;">기간</th>
                            <th style="width: 20%;">업무</th>
                            <th style="width: 35%;">퇴사사유</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if entry.career %}
                        {% for car in entry.career %}
                        <tr>
                            <td>{{ car.company }}</td>
                            <td>{{ car.start }}~{{ car.end }}</td>
                            <td>{{ car.role }}</td>
                            <td>{{ car.reason }}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="4" style="color: var(--text2);">경력 사항 없음</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>

                <div class="memo-box">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div style="font-weight: 700; font-size: 0.85rem; color: var(--text2);">관리자 메모</div>
                        <button type="button" id="btn-memo-{{ entry.id }}" onclick="saveMemo('{{ entry.id }}')"
                            class="btn btn-sm"
                            style="height: 28px; font-size: 0.8rem; padding: 0 10px; background: var(--text2); color: #fff;">저장</button>
                    </div>
                    <textarea id="memo-{{ entry.id }}" class="memo-textarea"
                        placeholder="특이사항 입력">{{ entry.memo }}</textarea>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</form>

{% if pagination.total > 0 %}
<div class="pagination">
    {% if pagination.has_prev %}
    <a href="javascript:goPage({{ pagination.prev_num }})" class="page-link">&#8249;</a>
    {% endif %}

    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
    {% if page_num %}
    {% if page_num == pagination.page %}
    <span class="page-link active">{{ page_num }}</span>
    {% else %}
    <a href="javascript:goPage({{ page_num }})" class="page-link">{{ page_num }}</a>
    {% endif %}
    {% else %}
    <span class="page-link" style="border:none;">...</span>
    {% endif %}
    {% endfor %}

    {% if pagination.has_next %}
    <a href="javascript:goPage({{ pagination.next_num }})" class="page-link">&#8250;</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block page_js %}
const csrfToken = '{{ csrf_token() }}';

function toggleAll(source) {
    document.getElementsByName('selected_ids').forEach(checkbox => {
        checkbox.checked = source.checked;
    });
}

function goPage(page) {
    const form = document.getElementById('searchForm');
    let pageInput = form.querySelector('input[name="page"]');
    if (!pageInput) {
        pageInput = document.createElement('input');
        pageInput.type = 'hidden';
        pageInput.name = 'page';
        form.appendChild(pageInput);
    }
    pageInput.value = page;
    form.submit();
}

async function changeAdminPassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const form = document.getElementById('passwordChangeForm');
    const btn = document.getElementById('changePasswordBtn');
    const originalText = btn.innerText;

    btn.innerText = "저장중..";
    btn.disabled = true;

    const formData = new FormData();
    formData.append('current_password', currentPassword);
    formData.append('new_password', newPassword);
    formData.append('confirm_password', confirmPassword);
    formData.append('csrf_token', csrfToken);

    try {
        const response = await fetch('/admin/change-password', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (result.success) {
            showToast(result.message || '비밀번호가 변경되었습니다.');
            form.reset();
        } else {
            showToast(result.message || '비밀번호 변경에 실패했습니다.');
        }
    } catch (error) {
        console.error(error);
        showToast('비밀번호 변경 중 오류가 발생했습니다.');
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
}

async function saveMemo(appId) {
    const memoText = document.getElementById(`memo-${appId}`).value;
    const btn = document.getElementById(`btn-memo-${appId}`);
    const originalText = btn.innerText;

    btn.innerText = "저장...";
    btn.disabled = true;

    const formData = new FormData();
    formData.append('memo', memoText);
    formData.append('csrf_token', csrfToken);

    try {
        const response = await fetch(`/update_memo/${appId}`, {
            method: 'POST', body: formData
        });
        const result = await response.json();
        if (result.success) {
            showToast('메모가 저장되었습니다.');
            btn.innerText = "완료";
            btn.style.background = "var(--success)";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.background = "";
                btn.disabled = false;
            }, 1500);
        } else {
            showToast('실패: ' + result.message);
            btn.disabled = false;
            btn.innerText = originalText;
        }
    } catch (error) {
        console.error(error);
        showToast('오류가 발생했습니다.');
        btn.disabled = false;
        btn.innerText = originalText;
    }
}

async function saveStatus(appId) {
    const statusVal = document.getElementById(`status-${appId}`).value;
    const btn = document.getElementById(`btn-status-${appId}`);
    const originalText = btn.innerText;

    btn.innerText = "저장...";
    btn.disabled = true;

    const formData = new FormData();
    formData.append('status', statusVal);
    formData.append('csrf_token', csrfToken);

    try {
        const response = await fetch(`/update_status/${appId}`, {
            method: 'POST', body: formData
        });
        const result = await response.json();
        if (result.success) {
            showToast('상태가 변경되었습니다.');
            btn.innerText = "완료";
            btn.style.background = "var(--success)";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.background = "";
                btn.disabled = false;
            }, 1500);
        } else {
            showToast('실패: ' + result.message);
            btn.disabled = false;
            btn.innerText = originalText;
        }
    } catch (error) {
        console.error(error);
        showToast('오류가 발생했습니다.');
        btn.disabled = false;
        btn.innerText = originalText;
    }
}
{% endblock %}
