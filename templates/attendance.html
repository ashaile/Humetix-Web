{% extends "base_public.html" %}

{% block public_title %}HUMETIX - 근무현황{% endblock %}

{% block page_css %}
:root {
    --bg: #f8f7f4;
    --bg2: #fff;
    --bg3: #f0efec;
    --text: #1a1a1a;
    --text2: #6b6b6b;
    --accent: #e85d26;
    --accent-bg: #fef3ee;
    --border: #e8e6e1;
    --success: #22a867;
    --success-bg: #edfbf3;
    --night: #6366f1;
    --night-bg: #eef2ff;
    --shadow: 0 1px 3px rgba(0, 0, 0, .06);
    --shadow-lg: 0 10px 25px rgba(0, 0, 0, .08);
    --radius: 12px;
    --radius-sm: 8px;
}

.attendance-container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 32px 24px;
    padding-top: 80px;
}

.page-title {
    font-size: 26px;
    font-weight: 800;
    margin-bottom: 8px;
}

.page-desc {
    color: var(--text2);
    font-size: 14px;
    margin-bottom: 24px;
}

.tab-row {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    background: var(--bg3);
    padding: 4px;
    border-radius: var(--radius-sm);
    width: fit-content;
    margin-left: auto;
    margin-right: auto;
}

.tab-btn {
    padding: 7px 16px;
    border-radius: 6px;
    border: none;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    background: transparent;
    color: var(--text2);
    transition: all .2s;
}

.tab-btn.active {
    background: var(--bg2);
    color: var(--text);
    box-shadow: var(--shadow);
}

.input-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    max-width: 540px;
    margin: 0 auto;
}

.input-card h3 {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 16px;
}

.form-group {
    margin-bottom: 16px;
}

.form-label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text2);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: .5px;
}

.form-input,
.form-select {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-family: inherit;
    background: var(--bg);
    color: var(--text);
}

.time-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.quick-btns {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-top: 6px;
}

.quick-btn {
    padding: 4px 10px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: var(--bg);
    font-size: 12px;
    cursor: pointer;
    font-family: inherit;
}

.quick-btn:hover,
.quick-btn.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
}

.work-type-btns {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.work-type-btn {
    padding: 7px 12px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: var(--bg);
    font-size: 12px;
    cursor: pointer;
    font-family: inherit;
    font-weight: 600;
    color: var(--text2);
}

.work-type-btn:hover,
.work-type-btn.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
}

.success-msg {
    background: var(--success-bg);
    border: 1px solid #86efac;
    border-radius: var(--radius-sm);
    padding: 14px 16px;
    font-size: 14px;
    color: #166534;
    font-weight: 600;
    margin-bottom: 16px;
    max-width: 540px;
    margin-left: auto;
    margin-right: auto;
}

.error-msg {
    background: #fef2f2;
    border: 1px solid #fca5a5;
    border-radius: var(--radius-sm);
    padding: 14px 16px;
    font-size: 14px;
    color: #dc2626;
    font-weight: 500;
    margin-bottom: 16px;
}

.att-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 20px;
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all .2s;
    font-family: inherit;
    white-space: nowrap;
    text-decoration: none;
}

.att-btn-primary {
    background: var(--accent);
    color: #fff;
}

.att-btn-primary:hover {
    background: #d14e1a;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(232, 93, 38, .3);
}

.att-btn-sm {
    padding: 7px 14px;
    font-size: 13px;
}

.filter-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 16px;
}

.table-wrap {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 12px;
}

.table-title {
    font-weight: 700;
    font-size: 15px;
}

.table-scroll {
    overflow-x: auto;
}

.attendance-container table {
    width: 100%;
    border-collapse: collapse;
    font-size: 15px;
}

.attendance-container thead {
    background: var(--bg3);
}

.attendance-container th {
    padding: 12px 18px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: .5px;
    color: var(--text2);
    white-space: nowrap;
}

.attendance-container td {
    padding: 14px 18px;
    border-top: 1px solid var(--border);
    white-space: nowrap;
}

.mono {
    font-family: "Inter", system-ui, sans-serif;
    font-variant-numeric: tabular-nums;
    font-size: 15px;
}
td.col-total { font-weight: 700; color: var(--text); }
td.col-ot { font-weight: 700; color: var(--success); }
td.col-night { font-weight: 700; color: var(--night); }
td.col-holiday { font-weight: 700; color: #d946ef; }

.emp-name {
    font-weight: 600;
}

.badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12.5px;
    font-weight: 600;
}

.badge-day {
    background: var(--accent-bg);
    color: var(--accent);
}

.badge-night {
    background: var(--night-bg);
    color: var(--night);
}

@media(max-width: 768px) {
    .attendance-container {
        padding: 16px;
        padding-top: 80px;
    }
    .time-row {
        grid-template-columns: 1fr;
    }
    .tab-row { width: 100%; }
    .tab-btn { flex: 1; text-align: center; }
    .filter-bar { flex-direction: column; align-items: stretch; }
    .quick-btn { min-height: 36px; }
    .att-btn { min-height: 44px; justify-content: center; }
    .attendance-container th,
    .attendance-container td { padding: 10px 12px; font-size: 12px; }
}
{% endblock %}

{% block public_content %}
<div class="attendance-container">
    <div class="tab-row">
        <button class="tab-btn active" type="button" onclick="showTab('input')">근무 입력</button>
        <button class="tab-btn" type="button" onclick="showTab('records')">근무 기록</button>
    </div>

    <div id="tab-input" style="max-width: 540px; margin: 0 auto;">
        <h1 class="page-title">근무 입력</h1>
        <p class="page-desc">출퇴근 및 근무 정보를 입력하세요.</p>

        <div id="input-success" style="display:none">
            <div class="success-msg">근무 기록이 저장되었습니다.</div>
        </div>

        <div class="input-card" id="input-form-card">
            <h3>근무 시간 입력</h3>
            <form id="attendance-form" onsubmit="return submitAttendance(event)">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="form-group">
                    <label class="form-label">생년월일 (YYMMDD)</label>
                    <input type="text" class="form-input" name="birth_date" maxlength="6" required>
                </div>

                <div class="form-group">
                    <label class="form-label">이름</label>
                    <input type="text" class="form-input" name="emp_name" required>
                </div>

                <div class="form-group">
                    <label class="form-label">부서/현장</label>
                    <input type="text" class="form-input" name="dept">
                </div>

                <div class="form-group">
                    <label class="form-label">날짜</label>
                    <input type="date" class="form-input" name="work_date" value="{{ today.strftime('%Y-%m-%d') }}"
                        required>
                </div>

                <div class="form-group">
                    <label class="form-label">근무 유형</label>
                    <input type="hidden" name="work_type" value="normal">
                    <div class="work-type-btns">
                        <button type="button" class="work-type-btn active" data-work-type="normal"
                            onclick="setWorkType('normal')">주간 근무</button>
                        <button type="button" class="work-type-btn" data-work-type="night"
                            onclick="setWorkType('night')">야간 근무</button>
                        <button type="button" class="work-type-btn" data-work-type="annual"
                            onclick="setWorkType('annual')">연차</button>
                        <button type="button" class="work-type-btn" data-work-type="absent"
                            onclick="setWorkType('absent')">결근</button>
                        <button type="button" class="work-type-btn" data-work-type="holiday"
                            onclick="setWorkType('holiday')">휴무</button>
                        <button type="button" class="work-type-btn" data-work-type="early"
                            onclick="setWorkType('early')">조퇴</button>
                    </div>
                </div>

                <div class="time-row" id="time-inputs">
                    <div class="form-group">
                        <label class="form-label">출근 시간</label>
                        <input type="time" class="form-input" name="clock_in" value="08:30" required>
                        <div class="quick-btns">
                            <button type="button" class="quick-btn" onclick="setTime('clock_in','06:00')">06:00</button>
                            <button type="button" class="quick-btn" onclick="setTime('clock_in','06:30')">06:30</button>
                            <button type="button" class="quick-btn" onclick="setTime('clock_in','07:00')">07:00</button>
                            <button type="button" class="quick-btn" onclick="setTime('clock_in','07:30')">07:30</button>
                            <button type="button" class="quick-btn" onclick="setTime('clock_in','08:00')">08:00</button>
                            <button type="button" class="quick-btn active" onclick="setTime('clock_in','08:30')">08:30</button>
                            <button type="button" class="quick-btn" onclick="setTime('clock_in','17:30')">17:30</button>
                            <button type="button" class="quick-btn" onclick="setTime('clock_in','19:00')">19:00</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">퇴근 시간</label>
                        <input type="time" class="form-input" name="clock_out" value="19:00" required>
                        <div class="quick-btns">
                            <button type="button" class="quick-btn" onclick="setTime('clock_out','04:00')">04:00</button>
                            <button type="button" class="quick-btn" onclick="setTime('clock_out','05:00')">05:00</button>
                            <button type="button" class="quick-btn" onclick="setTime('clock_out','05:30')">05:30</button>
                            <button type="button" class="quick-btn" onclick="setTime('clock_out','08:30')">08:30</button>
                            <button type="button" class="quick-btn" onclick="setTime('clock_out','17:30')">17:30</button>
                            <button type="button" class="quick-btn" onclick="setTime('clock_out','18:30')">18:30</button>
                            <button type="button" class="quick-btn active" onclick="setTime('clock_out','19:00')">19:00</button>
                            <button type="button" class="quick-btn" onclick="setTime('clock_out','21:00')">21:00</button>
                        </div>
                    </div>
                </div>

                <div id="form-error" class="error-msg" style="display:none"></div>
                <button type="submit" class="att-btn att-btn-primary" style="width:100%;justify-content:center;padding:12px;">
                    근무 기록 등록
                </button>
            </form>
        </div>
    </div>

    <div id="tab-records" style="display:none">
        <h1 class="page-title">근무 기록</h1>
        <p class="page-desc">날짜/이름 기준으로 근무 기록을 조회하세요.</p>

        <form id="filter-form" class="filter-bar" onsubmit="event.preventDefault(); loadRecords();">
            <input type="date" class="form-input" id="f-start" style="width:auto">
            <span style="color:var(--text2)">~</span>
            <input type="date" class="form-input" id="f-end" style="width:auto">
            <input type="text" class="form-input" id="f-emp" placeholder="이름" style="width:160px">
            <button type="button" class="att-btn att-btn-primary att-btn-sm" onclick="loadRecords()">조회</button>
        </form>

        <div class="table-wrap">
            <div class="table-header">
                <div class="table-title">근무 기록 목록</div>
            </div>
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th>이름</th>
                            <th>날짜</th>
                            <th>출근</th>
                            <th>퇴근</th>
                            <th>총근무(h)</th>
                            <th>잔업(h)</th>
                            <th>심야(h)</th>
                            <th>특근(h)</th>
                            <th>구분</th>
                        </tr>
                    </thead>
                    <tbody id="records-tbody">
                        {% if records %}
                        {% for r in records %}
                        <tr>
                            <td class="emp-name">{{ r.emp_name }}</td>
                            <td class="mono">{{ r.work_date.strftime('%Y-%m-%d') if r.work_date else '' }}</td>
                            <td class="mono">{{ r.clock_in or '' }}</td>
                            <td class="mono">{{ r.clock_out or '' }}</td>
                            <td class="mono col-total">{{ r.total_work_hours }}h</td>
                            <td class="mono col-ot">{{ r.overtime_hours }}h</td>
                            <td class="mono col-night">{{ r.night_hours }}h</td>
                            <td class="mono col-holiday">{{ r.holiday_work_hours or 0 }}h</td>
                            <td>
                                {% if r.work_type == 'night' %}
                                <span class="badge badge-night">야간</span>
                                {% elif r.work_type == 'normal' %}
                                <span class="badge badge-day">주간</span>
                                {% elif r.work_type == 'annual' %}
                                <span class="badge badge-day">연차</span>
                                {% elif r.work_type == 'absent' %}
                                <span class="badge badge-day">결근</span>
                                {% elif r.work_type == 'holiday' %}
                                <span class="badge badge-day">휴무</span>
                                {% elif r.work_type == 'early' %}
                                <span class="badge badge-day">조퇴</span>
                                {% else %}
                                <span class="badge badge-day">{{ r.work_type }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="9" style="text-align:center;padding:24px;color:var(--text2);">기록이 없습니다.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
function toggleTimeInputs(value) {
    const row = document.getElementById("time-inputs");
    const noTimeTypes = ["absent", "holiday", "annual"];
    const required = !noTimeTypes.includes(value);
    row.style.display = required ? "grid" : "none";
    row.querySelectorAll("input").forEach((input) => {
        input.required = required;
    });
}

function showTab(name) {
    document.getElementById("tab-input").style.display = name === "input" ? "" : "none";
    document.getElementById("tab-records").style.display = name === "records" ? "" : "none";
    const tabs = document.querySelectorAll(".tab-btn");
    tabs[0].classList.toggle("active", name === "input");
    tabs[1].classList.toggle("active", name === "records");
}

function setTime(field, value) {
    const input = document.querySelector(`[name="${field}"]`);
    input.value = value;
    const group = input.closest(".form-group");
    group.querySelectorAll(".quick-btn").forEach((btn) => {
        btn.classList.toggle("active", btn.textContent.trim() === value);
    });
}

function setWorkType(value) {
    const input = document.querySelector('input[name="work_type"]');
    input.value = value;
    document.querySelectorAll(".work-type-btn").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.workType === value);
    });
    toggleTimeInputs(value);
}

function submitAttendance(e) {
    e.preventDefault();
    const form = document.getElementById("attendance-form");
    const errorEl = document.getElementById("form-error");
    const successEl = document.getElementById("input-success");
    const formCard = document.getElementById("input-form-card");

    errorEl.style.display = "none";
    successEl.style.display = "none";

    const fd = new FormData(form);
    const data = {};
    fd.forEach((v, k) => data[k] = v);

    const csrfToken = (data.csrf_token || "").trim();
    delete data.csrf_token;

    if (!csrfToken) {
        errorEl.style.display = "";
        errorEl.textContent = "보안 토큰이 없습니다. 새로고침 후 다시 시도해 주세요.";
        return false;
    }

    fetch("/api/attendance", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
        },
        credentials: "same-origin",
        body: JSON.stringify(data),
    })
        .then(async (r) => {
            const raw = await r.text();
            let parsed = {};
            try {
                parsed = raw ? JSON.parse(raw) : {};
            } catch (_err) {
                parsed = {};
            }

            if (!r.ok) {
                const csrfFailed = raw.includes("CSRF") || raw.includes("csrf");
                const message = parsed.error
                    || (csrfFailed
                        ? "세션이 만료되었거나 보안 토큰이 유효하지 않습니다. 새로고침 후 다시 시도해 주세요."
                        : `요청 실패 (${r.status})`);
                throw new Error(message);
            }
            return parsed;
        })
        .then((res) => {
            if (!res.success) {
                throw new Error(res.error || "근무 기록 저장에 실패했습니다.");
            }

            successEl.style.display = "";
            formCard.style.display = "none";
            setTimeout(() => {
                successEl.style.display = "none";
                formCard.style.display = "";
                form.reset();
                setWorkType("normal");
            }, 1400);
        })
        .catch((err) => {
            errorEl.style.display = "";
            errorEl.textContent = err.message || "서버 연결 실패";
        });

    return false;
}

function loadRecords() {
    const start = document.getElementById("f-start").value;
    const end = document.getElementById("f-end").value;
    const emp = document.getElementById("f-emp").value.trim();
    const params = new URLSearchParams();
    if (start) params.append("start_date", start);
    if (end) params.append("end_date", end);
    if (emp) params.append("emp_name", emp);

    fetch(`/api/attendance?${params.toString()}`)
        .then((r) => r.json())
        .then((data) => {
            const tbody = document.getElementById("records-tbody");
            if (!data.records || data.records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:24px;color:var(--text2);">기록이 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = data.records.map((r) => {
                const badgeClass = r.work_type === "night" ? "badge-night" : "badge-day";
                const workTypeLabelMap = {
                    normal: "주간",
                    night: "야간",
                    annual: "연차",
                    absent: "결근",
                    holiday: "휴무",
                    early: "조퇴",
                };
                const workTypeLabel = workTypeLabelMap[r.work_type] || r.work_type;
                return `
                    <tr>
                        <td class="emp-name">${r.emp_name}</td>
                        <td class="mono">${r.work_date || ""}</td>
                        <td class="mono">${r.clock_in || ""}</td>
                        <td class="mono">${r.clock_out || ""}</td>
                        <td class="mono col-total">${r.total_work_hours}h</td>
                        <td class="mono col-ot">${r.overtime_hours}h</td>
                        <td class="mono col-night">${r.night_hours}h</td>
                        <td class="mono col-holiday">${r.holiday_work_hours || 0}h</td>
                        <td><span class="badge ${badgeClass}">${workTypeLabel}</span></td>
                    </tr>
                `;
            }).join("");
        });
}

document.addEventListener("DOMContentLoaded", () => {
    const workType = document.querySelector('input[name="work_type"]').value || "normal";
    setWorkType(workType);
});
{% endblock %}
