{% extends "base_admin.html" %}

{% block admin_title %}HUMETIX - 고객사 관리{% endblock %}
{% block page_title %}고객사 관리{% endblock %}
{% block page_desc %}고객사를 등록/수정하고 직원을 배정합니다. 미배정 인원: {{ unassigned }}명{% endblock %}

{% block page_css %}
.register-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 24px;
}
.register-card h3 {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 16px;
}
.form-row {
    display: flex;
    gap: 12px;
    align-items: flex-end;
    flex-wrap: wrap;
}
.action-btns { display: flex; gap: 4px; }
.assign-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px;
}
.assign-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    font-size: 14px;
}
.assign-item:hover { background: var(--bg3); border-radius: 4px; }
@media (max-width: 768px) {
    .form-row { flex-direction: column; }
    .form-group { width: 100%; }
    .action-btns { flex-wrap: wrap; }
}
{% endblock %}

{% block content %}
<div class="register-card">
    <h3>고객사 등록</h3>
    <div class="form-row">
        <div class="form-group">
            <label class="form-label">고객사명</label>
            <input type="text" id="site-name" class="form-input" placeholder="○○고객사">
        </div>
        <div class="form-group">
            <label class="form-label">주소</label>
            <input type="text" id="site-address" class="form-input" placeholder="주소 (선택)">
        </div>
        <div class="form-group">
            <label class="form-label">담당자</label>
            <input type="text" id="site-contact" class="form-input" placeholder="이름">
        </div>
        <div class="form-group">
            <label class="form-label">연락처</label>
            <input type="text" id="site-phone" class="form-input" placeholder="010-0000-0000">
        </div>
        <div>
            <button class="btn btn-primary" onclick="createSite()">등록</button>
        </div>
    </div>
</div>

<div class="table-wrap">
    <div class="table-header">
        <div class="table-title">고객사 목록 ({{ sites|length }}개)</div>
    </div>
    <div class="table-scroll">
        <table>
            <thead>
                <tr>
                    <th>고객사명</th>
                    <th>주소</th>
                    <th>담당자</th>
                    <th>연락처</th>
                    <th>재직 인원</th>
                    <th>상태</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody>
                {% for site in sites %}
                <tr id="site-row-{{ site.id }}">
                    <td class="emp-name">{{ site.name }}</td>
                    <td>{{ site.address }}</td>
                    <td>{{ site.contact_person }}</td>
                    <td class="mono">{{ site.contact_phone }}</td>
                    <td class="mono">{{ site.employees|selectattr('is_active')|list|length }}명</td>
                    <td>
                        {% if site.is_active %}
                        <span class="badge badge-active">활성</span>
                        {% else %}
                        <span class="badge badge-inactive">비활성</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-outline btn-sm" onclick='openEditSite({{ site.id }}, {{ site.to_dict()|tojson }})'>수정</button>
                            <button class="btn btn-outline btn-sm" onclick="openWageModal({{ site.id }}, '{{ site.name }}')">급여설정</button>
                            <button class="btn btn-outline btn-sm" onclick="openAssignModal({{ site.id }}, '{{ site.name }}')">배정</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteSite({{ site.id }}, '{{ site.name }}')">삭제</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% if not sites %}
                <tr>
                    <td colspan="7" style="text-align:center;padding:24px;color:var(--text2);">
                        등록된 고객사가 없습니다.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- 고객사 수정 모달 -->
<div id="editSiteModal" class="modal-overlay">
    <div class="modal-card">
        <h3>고객사 정보 수정</h3>
        <input type="hidden" id="editSiteId">
        <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">고객사명</label>
            <input type="text" id="editSiteName" class="form-input">
        </div>
        <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">주소</label>
            <input type="text" id="editSiteAddress" class="form-input">
        </div>
        <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">담당자</label>
            <input type="text" id="editSiteContact" class="form-input">
        </div>
        <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">연락처</label>
            <input type="text" id="editSitePhone" class="form-input">
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
            <button type="button" class="btn btn-outline btn-sm" onclick="closeEditSite()">취소</button>
            <button type="button" class="btn btn-primary btn-sm" onclick="submitEditSite()">저장</button>
        </div>
    </div>
</div>

<!-- 배정 모달 -->
<div id="assignModal" class="modal-overlay">
    <div class="modal-card">
        <h3 id="assignModalTitle">직원 배정</h3>
        <input type="hidden" id="assignSiteId">
        <div class="assign-list" id="assignList">
            {% for emp in employees %}
            <label class="assign-item">
                <input type="checkbox" value="{{ emp.id }}" data-site="{{ emp.site_id or '' }}">
                {{ emp.name }} ({{ emp.birth_date }})
                {% if emp.site %}<span style="font-size:11px;color:var(--text2);"> — {{ emp.site.name }}</span>{% endif %}
            </label>
            {% endfor %}
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
            <button type="button" class="btn btn-outline btn-sm" onclick="closeAssignModal()">취소</button>
            <button type="button" class="btn btn-primary btn-sm" onclick="submitAssign()">배정</button>
        </div>
    </div>
</div>

<!-- 급여 설정 모달 -->
<div id="wageModal" class="modal-overlay">
    <div class="modal-card" style="max-width:520px;">
        <h3 id="wageModalTitle">급여 설정</h3>
        <input type="hidden" id="wageSiteId">
        <p style="font-size:12px;color:var(--text2);margin-bottom:16px;">비워두면 시스템 기본값이 적용됩니다.</p>
        <!-- 급여 산정방식 -->
        <div class="form-group" style="margin-bottom:10px;">
            <label class="form-label">급여 산정방식</label>
            <select id="wageCalcMethod" class="form-input">
                <option value="">미설정 (상위 설정 따름)</option>
                <option value="standard">209h 고정 (주휴포함 차감)</option>
                <option value="daily_build">일급제 (0→쌓기)</option>
                <option value="actual">실근무시간 (주휴포함 시급)</option>
            </select>
        </div>
        <!-- 급여유형 -->
        <div class="form-group" style="margin-bottom:10px;">
            <label class="form-label">급여유형</label>
            <select id="wageType" class="form-input" onchange="toggleWageType('wage')">
                <option value="">미설정 (상위 설정 따름)</option>
                <option value="hourly">시급제</option>
                <option value="daily">공수제 (일당)</option>
            </select>
        </div>
        <!-- 시급제 -->
        <div id="wageHourlyGroup" class="form-group" style="margin-bottom:10px;">
            <label class="form-label">시급 (원)</label>
            <input type="number" id="wageHourly" class="form-input" placeholder="10320">
        </div>
        <!-- 공수제 -->
        <div id="wageDailyGroup" class="form-group" style="margin-bottom:10px;display:none;">
            <label class="form-label">일당 — 1공 단가 (원)</label>
            <input type="number" id="wageDaily" class="form-input" placeholder="150000">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div class="form-group">
                <label class="form-label">기본 근무시간</label>
                <input type="number" step="0.5" id="wageStdHours" class="form-input" placeholder="8.0">
            </div>
            <div class="form-group">
                <label class="form-label">휴게시간</label>
                <input type="number" step="0.5" id="wageBreak" class="form-input" placeholder="1.0">
            </div>
            <div class="form-group">
                <label class="form-label">잔업 계산방식</label>
                <select id="wageOtUnit" class="form-input" onchange="toggleOtUnit('wage')">
                    <option value="">미설정 (상위 설정 따름)</option>
                    <option value="rate">배율 (시급/일당 기준)</option>
                    <option value="fixed">시간당 정액</option>
                </select>
            </div>
            <div id="wageOtRateGroup" class="form-group">
                <label class="form-label">연장근로 배율</label>
                <input type="number" step="0.1" id="wageOt" class="form-input" placeholder="1.5">
            </div>
            <div id="wageOtFixedGroup" class="form-group" style="display:none;">
                <label class="form-label">잔업 시간당 금액 (원)</label>
                <input type="number" id="wageOtFixed" class="form-input" placeholder="20000">
            </div>
            <div class="form-group">
                <label class="form-label">야간 가산 배율</label>
                <input type="number" step="0.1" id="wageNight" class="form-input" placeholder="0.5">
            </div>
            <div class="form-group">
                <label class="form-label">무급휴일 배율</label>
                <input type="number" step="0.1" id="wageUnpaid" class="form-input" placeholder="1.5">
            </div>
            <div class="form-group">
                <label class="form-label">유급휴일 배율 (8h 이내)</label>
                <input type="number" step="0.1" id="wagePaid" class="form-input" placeholder="1.5">
            </div>
            <div class="form-group" style="grid-column:1/-1;">
                <label class="form-label">유급휴일 초과 배율 (8h 초과)</label>
                <input type="number" step="0.1" id="wagePaidOt" class="form-input" placeholder="2.0">
            </div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
            <button type="button" class="btn btn-outline btn-sm" onclick="closeWageModal()">취소</button>
            <button type="button" class="btn btn-primary btn-sm" id="wageSubmitBtn" onclick="submitWage()">저장</button>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
const csrfToken = '{{ csrf_token() }}';
const headers = { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken };

/* 전화번호 자동 하이픈 */
function formatPhone(input) {
    let v = input.value.replace(/[^0-9]/g, '');
    if (v.length > 11) v = v.slice(0, 11);
    if (v.length <= 3) {
        input.value = v;
    } else if (v.length <= 7) {
        input.value = v.slice(0, 3) + '-' + v.slice(3);
    } else {
        input.value = v.slice(0, 3) + '-' + v.slice(3, 7) + '-' + v.slice(7);
    }
}
document.getElementById('site-phone').addEventListener('input', function() { formatPhone(this); });
document.getElementById('editSitePhone').addEventListener('input', function() { formatPhone(this); });

async function createSite() {
    const name = document.getElementById('site-name').value.trim();
    if (!name) { showToast('고객사 이름을 입력하세요.'); return; }

    const btn = document.querySelector('.register-card .btn-primary');
    setButtonLoading(btn, true);
    try {
        const res = await fetch('/api/sites', {
            method: 'POST', headers,
            body: JSON.stringify({
                name,
                address: document.getElementById('site-address').value.trim(),
                contact_person: document.getElementById('site-contact').value.trim(),
                contact_phone: document.getElementById('site-phone').value.trim(),
            })
        });
        const data = await res.json();
        if (data.success) {
            showToast(name + ' 고객사가 등록되었습니다.');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(data.error || '등록 실패');
        }
    } finally {
        setButtonLoading(btn, false);
    }
}

function openEditSite(id, site) {
    document.getElementById('editSiteId').value = id;
    document.getElementById('editSiteName').value = site.name;
    document.getElementById('editSiteAddress').value = site.address || '';
    document.getElementById('editSiteContact').value = site.contact_person || '';
    document.getElementById('editSitePhone').value = site.contact_phone || '';
    document.getElementById('editSiteModal').classList.add('show');
}

function closeEditSite() {
    document.getElementById('editSiteModal').classList.remove('show');
}

async function submitEditSite() {
    const id = document.getElementById('editSiteId').value;
    const name = document.getElementById('editSiteName').value.trim();
    if (!name) { showToast('고객사명을 입력하세요.'); return; }

    const res = await fetch('/api/sites/' + id, {
        method: 'PUT', headers,
        body: JSON.stringify({
            name,
            address: document.getElementById('editSiteAddress').value.trim(),
            contact_person: document.getElementById('editSiteContact').value.trim(),
            contact_phone: document.getElementById('editSitePhone').value.trim(),
        })
    });
    const data = await res.json();
    if (data.success) {
        showToast('고객사 정보가 수정되었습니다.');
        setTimeout(() => location.reload(), 500);
    } else {
        showToast(data.error || '수정 실패');
    }
}

function deleteSite(id, name) {
    showConfirm(name + ' 고객사를 삭제하시겠습니까?', async () => {
        const res = await fetch('/api/sites/' + id, { method: 'DELETE', headers });
        const data = await res.json();
        if (data.success) {
            showToast(name + ' 고객사가 삭제되었습니다.');
            document.getElementById('site-row-' + id).remove();
        } else {
            showToast(data.error || '삭제 실패');
        }
    });
}

function openAssignModal(siteId, siteName) {
    document.getElementById('assignSiteId').value = siteId;
    document.getElementById('assignModalTitle').textContent = siteName + ' — 직원 배정';
    const checks = document.querySelectorAll('#assignList input[type="checkbox"]');
    checks.forEach(cb => {
        cb.checked = cb.dataset.site === String(siteId);
    });
    document.getElementById('assignModal').classList.add('show');
}

function closeAssignModal() {
    document.getElementById('assignModal').classList.remove('show');
}

async function submitAssign() {
    const siteId = document.getElementById('assignSiteId').value;
    const checks = document.querySelectorAll('#assignList input[type="checkbox"]');
    const assignIds = [];
    const unassignIds = [];
    checks.forEach(cb => {
        if (cb.checked && cb.dataset.site !== siteId) {
            assignIds.push(parseInt(cb.value));
        } else if (!cb.checked && cb.dataset.site === siteId) {
            unassignIds.push(parseInt(cb.value));
        }
    });

    if (assignIds.length > 0) {
        await fetch('/api/sites/' + siteId + '/assign', {
            method: 'POST', headers,
            body: JSON.stringify({ employee_ids: assignIds })
        });
    }
    if (unassignIds.length > 0) {
        await fetch('/api/sites/' + siteId + '/unassign', {
            method: 'POST', headers,
            body: JSON.stringify({ employee_ids: unassignIds })
        });
    }

    showToast('배정이 완료되었습니다.');
    setTimeout(() => location.reload(), 500);
}

/* ── 급여 설정 모달 ── */
const wageFields = [
    {id:'wageHourly', key:'hourly_wage'},
    {id:'wageDaily', key:'daily_wage'},
    {id:'wageStdHours', key:'standard_work_hours'},
    {id:'wageBreak', key:'break_hours'},
    {id:'wageOt', key:'overtime_rate'},
    {id:'wageNight', key:'night_bonus_rate'},
    {id:'wageUnpaid', key:'unpaid_holiday_rate'},
    {id:'wagePaid', key:'paid_holiday_rate'},
    {id:'wagePaidOt', key:'paid_holiday_ot_rate'},
    {id:'wageOtFixed', key:'overtime_fixed_amount'},
];

function toggleWageType(prefix) {
    const sel = document.getElementById(prefix + 'Type').value;
    document.getElementById(prefix + 'HourlyGroup').style.display = (sel === 'daily') ? 'none' : '';
    document.getElementById(prefix + 'DailyGroup').style.display = (sel === 'daily') ? '' : 'none';
}

function toggleOtUnit(prefix) {
    const sel = document.getElementById(prefix + 'OtUnit').value;
    document.getElementById(prefix + 'OtRateGroup').style.display = (sel === 'fixed') ? 'none' : '';
    document.getElementById(prefix + 'OtFixedGroup').style.display = (sel === 'fixed') ? '' : 'none';
}

async function openWageModal(siteId, siteName) {
    document.getElementById('wageSiteId').value = siteId;
    document.getElementById('wageModalTitle').textContent = siteName + ' — 급여 설정';

    // 초기화
    wageFields.forEach(f => {
        const el = document.getElementById(f.id);
        el.value = '';
        el.placeholder = '';
    });
    document.getElementById('wageCalcMethod').value = '';
    document.getElementById('wageType').value = '';
    document.getElementById('wageOtUnit').value = '';
    toggleWageType('wage');
    toggleOtUnit('wage');

    // 현재 설정 로드
    try {
        const res = await fetch('/api/sites/' + siteId + '/wage-config', { headers });
        const data = await res.json();
        if (data.success) {
            wageFields.forEach(f => {
                const el = document.getElementById(f.id);
                const rawVal = data.raw[f.key];
                el.value = rawVal != null ? rawVal : '';
                el.placeholder = data.resolved[f.key] || '';
            });
            // select 필드
            document.getElementById('wageCalcMethod').value = data.raw['calc_method'] || '';
            document.getElementById('wageType').value = data.raw['wage_type'] || '';
            document.getElementById('wageOtUnit').value = data.raw['overtime_unit'] || '';
            toggleWageType('wage');
            toggleOtUnit('wage');
        }
    } catch (e) {
        console.error(e);
    }

    document.getElementById('wageModal').classList.add('show');
}

function closeWageModal() {
    document.getElementById('wageModal').classList.remove('show');
}

async function submitWage() {
    const siteId = document.getElementById('wageSiteId').value;
    const payload = {};
    wageFields.forEach(f => {
        const val = document.getElementById(f.id).value.trim();
        payload[f.key] = val === '' ? null : val;
    });
    // select 필드
    payload['calc_method'] = document.getElementById('wageCalcMethod').value || null;
    payload['wage_type'] = document.getElementById('wageType').value || null;
    payload['overtime_unit'] = document.getElementById('wageOtUnit').value || null;

    const btn = document.getElementById('wageSubmitBtn');
    setButtonLoading(btn, true);
    try {
        const res = await fetch('/api/sites/' + siteId + '/wage-config', {
            method: 'PUT', headers,
            body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (data.success) {
            showToast('급여 설정이 저장되었습니다.');
            closeWageModal();
        } else {
            showToast(data.error || '저장 실패');
        }
    } finally {
        setButtonLoading(btn, false);
    }
}

/* 모달 배경 클릭으로 닫기 */
['editSiteModal','assignModal','wageModal'].forEach(id => {
    document.getElementById(id).addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('show');
    });
});
{% endblock %}
