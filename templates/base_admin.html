{% extends "base.html" %}

{% block title %}{% block admin_title %}HUMETIX 관리자{% endblock %}{% endblock %}

{% block base_css_link %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block body_content %}
<!-- Sidebar toggle (mobile) -->
<button class="sidebar-toggle" id="sidebarToggle" aria-label="메뉴 열기">&#9776;</button>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div class="admin-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand">Hume<span>tix</span></div>
        <nav class="sidebar-nav">
            {% set nav_items = [
                ('admin.master_view', '/humetix_master_99', 'icon', '&#127968;', '관리자 홈'),
                ('attendance.admin_attendance', '/admin/attendance', 'icon', '&#128203;', '근태관리'),
                ('attendance.admin_attendance_calendar', '/admin/attendance-calendar', 'icon', '&#128197;', '운영캘린더'),
                ('payslip.admin_payslip', '/admin/payslip', 'icon', '&#128176;', '급여명세서'),
                ('advance.admin_advance', '/admin/advance', 'icon', '&#127974;', '가불관리'),
                ('employee.admin_employees', '/admin/employees', 'icon', '&#128101;', '사원명부'),
                ('admin.inquiries', '/inquiries', 'icon', '&#128232;', '문의목록'),
            ] %}
            {% for endpoint, url, _type, icon_html, label in nav_items %}
            <a href="{{ url }}" class="sidebar-link{% if request.endpoint == endpoint %} active{% endif %}">
                <span class="icon">{{ icon_html|safe }}</span> {{ label }}
            </a>
            {% endfor %}
            <button type="button" class="sidebar-link sidebar-action-link" id="openPasswordModalBtn">
                <span class="icon">&#128274;</span> 비밀번호 변경
            </button>
        </nav>
        <div class="sidebar-footer">
            <a href="/logout" class="sidebar-link">
                <span class="icon">&#128275;</span> 로그아웃
            </a>
        </div>
    </aside>

    <!-- Main content -->
    <main class="admin-main">
        <div class="page-header">
            <h1 class="page-title">{% block page_title %}{% endblock %}</h1>
            <p class="page-desc">{% block page_desc %}{% endblock %}</p>
        </div>
        {% block content %}{% endblock %}
    </main>
</div>

<div class="modal-overlay" id="passwordModal">
    <div class="modal-card">
        <h3>관리자 비밀번호 변경</h3>
        <form id="passwordChangeModalForm" class="password-modal-form">
            <div class="password-modal-group">
                <label for="modalCurrentPassword">현재 비밀번호</label>
                <input type="password" id="modalCurrentPassword" class="form-input" required>
            </div>
            <div class="password-modal-group">
                <label for="modalNewPassword">새 비밀번호</label>
                <input type="password" id="modalNewPassword" class="form-input" minlength="8" required>
            </div>
            <div class="password-modal-group">
                <label for="modalConfirmPassword">새 비밀번호 확인</label>
                <input type="password" id="modalConfirmPassword" class="form-input" minlength="8" required>
            </div>
            <div class="password-modal-actions">
                <button type="button" class="btn btn-outline btn-sm" id="cancelPasswordModalBtn">취소</button>
                <button type="submit" class="btn btn-primary btn-sm" id="changePasswordModalBtn">변경</button>
            </div>
        </form>
    </div>
</div>

<div id="confirmModal" class="modal-overlay">
    <div class="modal-card">
        <div class="confirm-modal-msg" id="confirmMsg"></div>
        <div id="confirmInputWrap" style="display:none;"></div>
        <div class="confirm-modal-actions">
            <button type="button" class="btn btn-outline btn-sm" id="confirmCancelBtn">취소</button>
            <button type="button" class="btn btn-primary btn-sm" id="confirmOkBtn">확인</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>
{% endblock %}

{% block base_js %}
<script>
    window.csrfToken = '{{ csrf_token() }}';

    /* Sidebar toggle */
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('open');
        sidebarOverlay.classList.toggle('show');
    });
    sidebarOverlay.addEventListener('click', () => {
        sidebar.classList.remove('open');
        sidebarOverlay.classList.remove('show');
    });

    /* Toast helper */
    function showToast(msg, duration) {
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', duration || 3000);
    }

    /* Password change modal */
    const passwordModal = document.getElementById('passwordModal');
    const passwordForm = document.getElementById('passwordChangeModalForm');
    const openPasswordModalBtn = document.getElementById('openPasswordModalBtn');
    const cancelPasswordModalBtn = document.getElementById('cancelPasswordModalBtn');
    const changePasswordModalBtn = document.getElementById('changePasswordModalBtn');

    function closePasswordModal() {
        passwordModal.classList.remove('show');
    }

    openPasswordModalBtn.addEventListener('click', () => {
        passwordForm.reset();
        passwordModal.classList.add('show');
    });

    cancelPasswordModalBtn.addEventListener('click', closePasswordModal);

    passwordModal.addEventListener('click', (event) => {
        if (event.target === passwordModal) {
            closePasswordModal();
        }
    });

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && passwordModal.classList.contains('show')) {
            closePasswordModal();
        }
    });

    /* ── Confirm / Prompt / Alert helpers ── */
    const confirmModal = document.getElementById('confirmModal');
    const confirmMsg = document.getElementById('confirmMsg');
    const confirmInputWrap = document.getElementById('confirmInputWrap');
    const confirmOkBtn = document.getElementById('confirmOkBtn');
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');

    let _confirmResolve = null;

    function _closeConfirmModal() {
        confirmModal.classList.remove('show');
        _confirmResolve = null;
    }

    confirmCancelBtn.addEventListener('click', () => {
        if (_confirmResolve) _confirmResolve(null);
        _closeConfirmModal();
    });

    confirmModal.addEventListener('click', (e) => {
        if (e.target === confirmModal) {
            if (_confirmResolve) _confirmResolve(null);
            _closeConfirmModal();
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && confirmModal.classList.contains('show')) {
            if (_confirmResolve) _confirmResolve(null);
            _closeConfirmModal();
        }
    });

    function showConfirm(message, onConfirm) {
        confirmMsg.textContent = message;
        confirmInputWrap.style.display = 'none';
        confirmInputWrap.innerHTML = '';
        confirmCancelBtn.style.display = '';
        confirmOkBtn.textContent = '확인';
        confirmModal.classList.add('show');

        _confirmResolve = null;
        confirmOkBtn.onclick = () => {
            _closeConfirmModal();
            if (onConfirm) onConfirm();
        };
    }

    function showPrompt(message, options, onSubmit) {
        confirmMsg.textContent = message;
        confirmCancelBtn.style.display = '';
        confirmOkBtn.textContent = '확인';

        const inputType = (options && options.type) || 'text';
        const placeholder = (options && options.placeholder) || '';
        let inputEl;
        if (inputType === 'textarea') {
            inputEl = document.createElement('textarea');
            inputEl.className = 'confirm-modal-input';
        } else {
            inputEl = document.createElement('input');
            inputEl.type = inputType;
            inputEl.className = 'confirm-modal-input';
        }
        inputEl.placeholder = placeholder;
        if (options && options.value) inputEl.value = options.value;

        confirmInputWrap.innerHTML = '';
        confirmInputWrap.appendChild(inputEl);
        confirmInputWrap.style.display = 'block';
        confirmModal.classList.add('show');
        setTimeout(() => inputEl.focus(), 50);

        _confirmResolve = null;
        confirmOkBtn.onclick = () => {
            const val = inputEl.value;
            _closeConfirmModal();
            if (onSubmit) onSubmit(val);
        };
    }

    function showAlert(message) {
        confirmMsg.textContent = message;
        confirmInputWrap.style.display = 'none';
        confirmInputWrap.innerHTML = '';
        confirmCancelBtn.style.display = 'none';
        confirmOkBtn.textContent = '확인';
        confirmModal.classList.add('show');

        return new Promise((resolve) => {
            _confirmResolve = resolve;
            confirmOkBtn.onclick = () => {
                _closeConfirmModal();
                resolve(true);
            };
        });
    }

    /* ── Button loading helper ── */
    function setButtonLoading(btn, loading) {
        if (loading) {
            btn.disabled = true;
            btn._origHTML = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span> 처리중...';
        } else {
            btn.disabled = false;
            if (btn._origHTML !== undefined) btn.innerHTML = btn._origHTML;
        }
    }

    passwordForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        const formData = new FormData();
        formData.append('current_password', document.getElementById('modalCurrentPassword').value);
        formData.append('new_password', document.getElementById('modalNewPassword').value);
        formData.append('confirm_password', document.getElementById('modalConfirmPassword').value);
        formData.append('csrf_token', window.csrfToken || '');

        const originalText = changePasswordModalBtn.innerText;
        changePasswordModalBtn.disabled = true;
        changePasswordModalBtn.innerText = '처리중...';

        try {
            const response = await fetch('/admin/change-password', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                showToast(result.message || '비밀번호가 변경되었습니다.');
                passwordForm.reset();
                closePasswordModal();
            } else {
                showToast(result.message || '비밀번호 변경에 실패했습니다.');
            }
        } catch (error) {
            console.error(error);
            showToast('비밀번호 변경 중 오류가 발생했습니다.');
        } finally {
            changePasswordModalBtn.disabled = false;
            changePasswordModalBtn.innerText = originalText;
        }
    });
</script>
{% endblock %}
