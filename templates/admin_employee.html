{% extends "base_admin.html" %}

{% block admin_title %}HUMETIX - 사원 명부 관리{% endblock %}
{% block page_title %}사원 명부 관리{% endblock %}
{% block page_desc %}사원을 등록하고 입사일/퇴사일을 관리합니다. 등록된 사원만 근무 입력과 가불 신청이 가능합니다.{% endblock %}

{% block page_css %}
.register-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 24px;
}
.register-card h3 {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 16px;
}
.form-row {
    display: flex;
    gap: 12px;
    align-items: flex-end;
    flex-wrap: wrap;
}
.action-btns {
    display: flex;
    gap: 4px;
}
@media (max-width: 600px) {
    .form-row {
        flex-direction: column;
    }
    .form-group {
        width: 100%;
    }
    th, td {
        padding: 8px 10px;
        font-size: 12px;
    }
}
{% endblock %}

{% block content %}
<!-- 사원 등록 -->
<div class="register-card">
    <h3>사원 등록</h3>
    <div class="form-row">
        <div class="form-group">
            <label class="form-label">이름</label>
            <input type="text" id="emp-name" class="form-input" placeholder="홍길동">
        </div>
        <div class="form-group">
            <label class="form-label">생년월일 (YYMMDD)</label>
            <input type="text" id="emp-birth" class="form-input" placeholder="900101" maxlength="6">
        </div>
        <div class="form-group">
            <label class="form-label">입사일</label>
            <input type="date" id="emp-hire" class="form-input">
        </div>
        <div class="form-group">
            <label class="form-label">고객사</label>
            <select id="emp-site" class="form-input">
                <option value="">미배정</option>
                {% for site in sites %}
                <option value="{{ site.id }}">{{ site.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">공제유형</label>
            <select id="emp-insurance" class="form-input">
                <option value="3.3%">소득세 3.3%</option>
                <option value="4대보험">4대보험</option>
            </select>
        </div>
        <div>
            <button class="btn btn-primary" onclick="createEmployee()">등록</button>
        </div>
    </div>
</div>

<!-- 사원 목록 -->
<div class="table-wrap">
    <div class="table-header">
        <div class="table-title">등록된 사원 ({{ employees|length }}명)</div>
    </div>
    <div class="table-scroll">
        <table>
            <thead>
                <tr>
                    <th>이름</th>
                    <th>생년월일</th>
                    <th>고객사</th>
                    <th>공제유형</th>
                    <th>입사일</th>
                    <th>퇴사일</th>
                    <th>상태</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in employees %}
                <tr id="row-{{ emp.id }}">
                    <td class="emp-name">{{ emp.name }}</td>
                    <td class="mono">{{ emp.birth_date }}</td>
                    <td>{{ emp.site.name if emp.site else '-' }}</td>
                    <td>
                        {% if emp.insurance_type == '4대보험' %}
                        <span class="badge badge-active">4대보험</span>
                        {% else %}
                        <span class="badge" style="background:#FEF3C7;color:#D97706;">3.3%</span>
                        {% endif %}
                    </td>
                    <td class="mono">{{ emp.hire_date.strftime('%Y-%m-%d') if emp.hire_date else '-' }}</td>
                    <td class="mono">{{ emp.resign_date.strftime('%Y-%m-%d') if emp.resign_date else '-' }}</td>
                    <td>
                        {% if emp.is_active %}
                        <span class="badge badge-active">재직</span>
                        {% else %}
                        <span class="badge badge-inactive">퇴직</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-outline btn-sm"
                                onclick='openEditEmp({{ emp.id }}, {{ emp.to_dict()|tojson }})'>수정</button>
                            <button class="btn btn-outline btn-sm"
                                onclick="openEmpWageModal({{ emp.id }}, '{{ emp.name }}')">급여설정</button>
                            {% if emp.is_active %}
                            <button class="btn btn-outline btn-sm"
                                onclick="markResign({{ emp.id }}, '{{ emp.name }}')">퇴사</button>
                            {% else %}
                            <button class="btn btn-success btn-sm"
                                onclick="reactivate({{ emp.id }})">재활성화</button>
                            {% endif %}
                            <button class="btn btn-danger btn-sm"
                                onclick="deleteEmployee({{ emp.id }}, '{{ emp.name }}')">삭제</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% if not employees %}
                <tr>
                    <td colspan="8" style="text-align:center;padding:24px;color:var(--text2);">
                        등록된 사원이 없습니다. 위 양식으로 사원을 등록해주세요.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- 사원 수정 모달 -->
<div id="editEmpModal" class="modal-overlay">
    <div class="modal-card">
        <h3>사원 정보 수정</h3>
        <input type="hidden" id="editEmpId">
        <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">이름</label>
            <input type="text" id="editEmpName" class="form-input">
        </div>
        <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">생년월일 (YYMMDD)</label>
            <input type="text" id="editEmpBirth" class="form-input" maxlength="6">
        </div>
        <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">근무형태</label>
            <select id="editEmpWorkType" class="form-input">
                <option value="weekly">주간</option>
                <option value="shift">교대</option>
            </select>
        </div>
        <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">공제유형</label>
            <select id="editEmpInsurance" class="form-input">
                <option value="3.3%">소득세 3.3%</option>
                <option value="4대보험">4대보험</option>
            </select>
        </div>
        <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">입사일</label>
            <input type="date" id="editEmpHire" class="form-input">
        </div>
        <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">고객사</label>
            <select id="editEmpSite" class="form-input">
                <option value="">미배정</option>
                {% for site in sites %}
                <option value="{{ site.id }}">{{ site.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
            <button type="button" class="btn btn-outline btn-sm" onclick="closeEditEmp()">취소</button>
            <button type="button" class="btn btn-primary btn-sm" onclick="submitEditEmp()">저장</button>
        </div>
    </div>
</div>
<!-- 직원 급여 설정 모달 -->
<div id="empWageModal" class="modal-overlay">
    <div class="modal-card" style="max-width:560px;">
        <h3 id="empWageTitle">급여 설정</h3>
        <input type="hidden" id="empWageId">
        <p style="font-size:12px;color:var(--text2);margin-bottom:12px;">
            비워두면 고객사 설정 → 시스템 기본값 순서로 적용됩니다.
        </p>
        <!-- 출처 표시 영역 -->
        <div id="empWageSourceInfo" style="font-size:12px;margin-bottom:16px;display:none;">
            <table style="width:100%;border-collapse:collapse;">
                <thead>
                    <tr style="border-bottom:1px solid var(--border);">
                        <th style="text-align:left;padding:4px 8px;color:var(--text2);">항목</th>
                        <th style="text-align:right;padding:4px 8px;color:var(--text2);">현재값</th>
                        <th style="text-align:left;padding:4px 8px;color:var(--text2);">출처</th>
                    </tr>
                </thead>
                <tbody id="empWageSourceBody"></tbody>
            </table>
        </div>
        <!-- 급여 산정방식 -->
        <div class="form-group" style="margin-bottom:10px;">
            <label class="form-label">급여 산정방식</label>
            <select id="ewCalcMethod" class="form-input">
                <option value="">미설정 (상위 설정 따름)</option>
                <option value="standard">209h 고정 (주휴포함 차감)</option>
                <option value="daily_build">일급제 (0→쌓기)</option>
                <option value="actual">실근무시간 (주휴포함 시급)</option>
            </select>
        </div>
        <!-- 급여유형 -->
        <div class="form-group" style="margin-bottom:10px;">
            <label class="form-label">급여유형</label>
            <select id="ewType" class="form-input" onchange="toggleWageType('ew')">
                <option value="">미설정 (상위 설정 따름)</option>
                <option value="hourly">시급제</option>
                <option value="daily">공수제 (일당)</option>
            </select>
        </div>
        <!-- 시급제 -->
        <div id="ewHourlyGroup" class="form-group" style="margin-bottom:10px;">
            <label class="form-label">시급 (원)</label>
            <input type="number" id="ewHourly" class="form-input" placeholder="10320">
        </div>
        <!-- 공수제 -->
        <div id="ewDailyGroup" class="form-group" style="margin-bottom:10px;display:none;">
            <label class="form-label">일당 — 1공 단가 (원)</label>
            <input type="number" id="ewDaily" class="form-input" placeholder="150000">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div class="form-group">
                <label class="form-label">기본 근무시간</label>
                <input type="number" step="0.5" id="ewStdHours" class="form-input" placeholder="8.0">
            </div>
            <div class="form-group">
                <label class="form-label">휴게시간</label>
                <input type="number" step="0.5" id="ewBreak" class="form-input" placeholder="1.0">
            </div>
            <div class="form-group">
                <label class="form-label">잔업 계산방식</label>
                <select id="ewOtUnit" class="form-input" onchange="toggleOtUnit('ew')">
                    <option value="">미설정 (상위 설정 따름)</option>
                    <option value="rate">배율 (시급/일당 기준)</option>
                    <option value="fixed">시간당 정액</option>
                </select>
            </div>
            <div id="ewOtRateGroup" class="form-group">
                <label class="form-label">연장근로 배율</label>
                <input type="number" step="0.1" id="ewOt" class="form-input" placeholder="1.5">
            </div>
            <div id="ewOtFixedGroup" class="form-group" style="display:none;">
                <label class="form-label">잔업 시간당 금액 (원)</label>
                <input type="number" id="ewOtFixed" class="form-input" placeholder="20000">
            </div>
            <div class="form-group">
                <label class="form-label">야간 가산 배율</label>
                <input type="number" step="0.1" id="ewNight" class="form-input" placeholder="0.5">
            </div>
            <div class="form-group">
                <label class="form-label">무급휴일 배율</label>
                <input type="number" step="0.1" id="ewUnpaid" class="form-input" placeholder="1.5">
            </div>
            <div class="form-group">
                <label class="form-label">유급휴일 배율 (8h 이내)</label>
                <input type="number" step="0.1" id="ewPaid" class="form-input" placeholder="1.5">
            </div>
            <div class="form-group" style="grid-column:1/-1;">
                <label class="form-label">유급휴일 초과 배율 (8h 초과)</label>
                <input type="number" step="0.1" id="ewPaidOt" class="form-input" placeholder="2.0">
            </div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
            <button type="button" class="btn btn-outline btn-sm" onclick="closeEmpWageModal()">취소</button>
            <button type="button" class="btn btn-primary btn-sm" id="ewSubmitBtn" onclick="submitEmpWage()">저장</button>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
const csrfToken = '{{ csrf_token() }}';

async function createEmployee() {
    const name = document.getElementById('emp-name').value.trim();
    const birth_date = document.getElementById('emp-birth').value.trim();
    const hire_date = document.getElementById('emp-hire').value;

    if (!name) { showToast('이름을 입력하세요.'); return; }
    if (!birth_date || birth_date.length !== 6) { showToast('생년월일 6자리를 입력하세요.'); return; }

    const site_id = document.getElementById('emp-site').value;
    const insurance_type = document.getElementById('emp-insurance').value;
    const body = { name, birth_date, insurance_type };
    if (hire_date) body.hire_date = hire_date;
    if (site_id) body.site_id = parseInt(site_id);

    const btn = document.querySelector('.register-card .btn-primary');
    setButtonLoading(btn, true);

    try {
        const res = await fetch('/api/employees', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify(body)
        });
        const data = await res.json();

        if (data.success) {
            showToast(name + ' 사원이 등록되었습니다.');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(data.error || '등록 실패');
        }
    } finally {
        setButtonLoading(btn, false);
    }
}

function markResign(id, name) {
    showPrompt(name + ' 사원의 퇴사일을 입력하세요 (YYYY-MM-DD):', {
        type: 'date',
        value: new Date().toISOString().slice(0, 10)
    }, async (resignDate) => {
        if (!resignDate) return;

        const res = await fetch('/api/employees/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ is_active: false, resign_date: resignDate })
        });
        const data = await res.json();

        if (data.success) {
            showToast(name + ' 사원이 퇴사 처리되었습니다.');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(data.error || '처리 실패');
        }
    });
}

async function reactivate(id) {
    const res = await fetch('/api/employees/' + id, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify({ is_active: true, resign_date: '' })
    });
    const data = await res.json();

    if (data.success) {
        showToast('사원이 재활성화되었습니다.');
        setTimeout(() => location.reload(), 500);
    } else {
        showToast(data.error || '처리 실패');
    }
}

function deleteEmployee(id, name) {
    showConfirm(name + ' 사원을 명부에서 삭제하시겠습니까?\n(퇴사 처리를 권장합니다)', async () => {
        const res = await fetch('/api/employees/' + id, { method: 'DELETE', headers: { 'X-CSRFToken': csrfToken } });
        const data = await res.json();

        if (data.success) {
            showToast(name + ' 사원이 삭제되었습니다.');
            document.getElementById('row-' + id).remove();
        } else {
            showToast(data.error || '삭제 실패');
        }
    });
}

function openEditEmp(id, emp) {
    document.getElementById('editEmpId').value = id;
    document.getElementById('editEmpName').value = emp.name;
    document.getElementById('editEmpBirth').value = emp.birth_date;
    document.getElementById('editEmpWorkType').value = emp.work_type || 'weekly';
    document.getElementById('editEmpInsurance').value = emp.insurance_type || '3.3%';
    document.getElementById('editEmpHire').value = emp.hire_date || '';
    document.getElementById('editEmpSite').value = emp.site_id || '';
    document.getElementById('editEmpModal').classList.add('show');
}

function closeEditEmp() {
    document.getElementById('editEmpModal').classList.remove('show');
}

async function submitEditEmp() {
    const id = document.getElementById('editEmpId').value;
    const name = document.getElementById('editEmpName').value.trim();
    const birth_date = document.getElementById('editEmpBirth').value.trim();

    if (!name) { showToast('이름을 입력하세요.'); return; }
    if (!birth_date || birth_date.length !== 6) { showToast('생년월일 6자리를 입력하세요.'); return; }

    const body = {
        name,
        birth_date,
        work_type: document.getElementById('editEmpWorkType').value,
        insurance_type: document.getElementById('editEmpInsurance').value,
        hire_date: document.getElementById('editEmpHire').value || '',
        site_id: document.getElementById('editEmpSite').value || null,
    };

    const res = await fetch('/api/employees/' + id, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.success) {
        showToast('사원 정보가 수정되었습니다.');
        setTimeout(() => location.reload(), 500);
    } else {
        showToast(data.error || '수정 실패');
    }
}

/* ── 직원 급여 설정 ──────────────────────── */
const ewFields = [
    {id:'ewHourly', key:'hourly_wage'},
    {id:'ewDaily', key:'daily_wage'},
    {id:'ewStdHours', key:'standard_work_hours'},
    {id:'ewBreak', key:'break_hours'},
    {id:'ewOt', key:'overtime_rate'},
    {id:'ewNight', key:'night_bonus_rate'},
    {id:'ewUnpaid', key:'unpaid_holiday_rate'},
    {id:'ewPaid', key:'paid_holiday_rate'},
    {id:'ewPaidOt', key:'paid_holiday_ot_rate'},
    {id:'ewOtFixed', key:'overtime_fixed_amount'},
];

function toggleWageType(prefix) {
    const sel = document.getElementById(prefix + 'Type').value;
    document.getElementById(prefix + 'HourlyGroup').style.display = (sel === 'daily') ? 'none' : '';
    document.getElementById(prefix + 'DailyGroup').style.display = (sel === 'daily') ? '' : 'none';
}

function toggleOtUnit(prefix) {
    const sel = document.getElementById(prefix + 'OtUnit').value;
    document.getElementById(prefix + 'OtRateGroup').style.display = (sel === 'fixed') ? 'none' : '';
    document.getElementById(prefix + 'OtFixedGroup').style.display = (sel === 'fixed') ? '' : 'none';
}

const VALUE_DISPLAY = {
    'wage_type': v => v === 'hourly' ? '시급제' : v === 'daily' ? '공수제' : v,
    'overtime_unit': v => v === 'rate' ? '배율' : v === 'fixed' ? '정액' : v,
    'calc_method': v => v === 'standard' ? '209h 고정' : v === 'daily_build' ? '일급제' : v === 'actual' ? '실근무시간' : v || '미설정',
};

async function openEmpWageModal(empId, empName) {
    document.getElementById('empWageId').value = empId;
    document.getElementById('empWageTitle').textContent = empName + ' — 급여 설정';

    // 필드 초기화
    ewFields.forEach(f => {
        document.getElementById(f.id).value = '';
        document.getElementById(f.id).placeholder = '';
    });
    document.getElementById('ewCalcMethod').value = '';
    document.getElementById('ewType').value = '';
    document.getElementById('ewOtUnit').value = '';
    toggleWageType('ew');
    toggleOtUnit('ew');
    document.getElementById('empWageSourceInfo').style.display = 'none';

    try {
        const res = await fetch('/api/employees/' + empId + '/wage-config', {
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }
        });
        const data = await res.json();
        if (data.success) {
            // 입력 필드에 raw(개별 설정) 값 채우기
            ewFields.forEach(f => {
                const el = document.getElementById(f.id);
                const rawVal = data.raw[f.key];
                el.value = rawVal != null ? rawVal : '';
            });
            // select 필드
            document.getElementById('ewCalcMethod').value = data.raw['calc_method'] || '';
            document.getElementById('ewType').value = data.raw['wage_type'] || '';
            document.getElementById('ewOtUnit').value = data.raw['overtime_unit'] || '';
            toggleWageType('ew');
            toggleOtUnit('ew');

            // 출처 테이블 표시
            if (data.detail && data.detail.length) {
                const tbody = document.getElementById('empWageSourceBody');
                tbody.innerHTML = '';
                data.detail.forEach(d => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid var(--border)';
                    const srcBadge = d.source === 'employee'
                        ? '<span style="color:#059669;font-weight:600;">' + d.source_name + '</span>'
                        : '<span style="color:var(--text2);">' + d.source_name + '</span>';
                    const displayVal = VALUE_DISPLAY[d.field]
                        ? VALUE_DISPLAY[d.field](d.value)
                        : (d.value != null ? d.value.toLocaleString() : '-');
                    tr.innerHTML = '<td style="padding:4px 8px;">' + d.label + '</td>'
                        + '<td style="text-align:right;padding:4px 8px;font-weight:600;">' + displayVal + '</td>'
                        + '<td style="padding:4px 8px;">' + srcBadge + '</td>';
                    tbody.appendChild(tr);

                    // placeholder에 해석된 값 표시
                    const field = ewFields.find(f => f.key === d.field);
                    if (field) {
                        document.getElementById(field.id).placeholder = d.value != null ? d.value : '';
                    }
                });
                document.getElementById('empWageSourceInfo').style.display = 'block';
            }
        }
    } catch (e) {
        console.error(e);
    }

    document.getElementById('empWageModal').classList.add('show');
}

function closeEmpWageModal() {
    document.getElementById('empWageModal').classList.remove('show');
}

async function submitEmpWage() {
    const empId = document.getElementById('empWageId').value;
    const payload = {};
    ewFields.forEach(f => {
        const val = document.getElementById(f.id).value.trim();
        payload[f.key] = val === '' ? null : val;
    });
    // select 필드
    payload['calc_method'] = document.getElementById('ewCalcMethod').value || null;
    payload['wage_type'] = document.getElementById('ewType').value || null;
    payload['overtime_unit'] = document.getElementById('ewOtUnit').value || null;

    const btn = document.getElementById('ewSubmitBtn');
    setButtonLoading(btn, true);
    try {
        const res = await fetch('/api/employees/' + empId + '/wage-config', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (data.success) {
            showToast('급여 설정이 저장되었습니다.');
            closeEmpWageModal();
        } else {
            showToast(data.error || '저장 실패');
        }
    } finally {
        setButtonLoading(btn, false);
    }
}

/* 모달 배경 클릭으로 닫기 */
['editEmpModal','empWageModal'].forEach(id => {
    document.getElementById(id).addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('show');
    });
});
{% endblock %}
